<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trình Biên Tập Sơ Đồ Đơn Tuyến</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { 
            font-family: sans-serif; 
            user-select: none; 
            -webkit-user-select: none; 
            overscroll-behavior: none; 
            touch-action: none; 
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes slideUp {
            from { transform: translate(-50%, 100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        .animate-slide-up {
            animation: slideUp 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen w-screen flex flex-col overflow-hidden">

    <div id="root" class="h-full w-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- CẤU HÌNH ---
        const GRID_SIZE = 20;
        const COLORS = { wire: '#000000', grid: '#cbd5e1', pvlv: '#ef4444', highlight: '#3b82f6', text: '#000000' };
        
        const TOOL_BTN_CLASS = "flex flex-col items-center justify-center px-2 py-1 rounded border border-transparent hover:bg-gray-100 min-w-[55px] transition-colors cursor-pointer active:bg-gray-200 touch-manipulation";
        const ACTION_BTN_CLASS = "flex items-center gap-2 border px-3 py-2 rounded-full shadow-md bg-white hover:bg-gray-50 transition-all active:scale-95 cursor-pointer text-sm font-medium whitespace-nowrap touch-manipulation";

        const snapToGrid = (val) => Math.round(val / GRID_SIZE) * GRID_SIZE;

        // --- ICONS ---
        const Icons = {
            Minus: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Zap: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>,
            Square: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>,
            Type: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg>,
            Trash2: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>,
            RotateCcw: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 4v6h6"></path><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>,
            Save: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>,
            Edit: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
            X: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
            Grid: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>,
            ZoomIn: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>,
            ZoomOut: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
        };

        const App = () => {
            const [objects, setObjects] = useState([]);
            const [selectedId, setSelectedId] = useState(null);
            
            // --- VIEWPORT STATE ---
            const [viewport, setViewport] = useState({ x: 0, y: 0, scale: 1 });
            const [isPanning, setIsPanning] = useState(false);
            const [lastPanPoint, setLastPanPoint] = useState({ x: 0, y: 0 });
            
            // --- DRAG OBJECT STATE ---
            const [dragState, setDragState] = useState({ 
                isDragging: false, 
                draggedId: null, 
                startX: 0, 
                startY: 0, 
                initialObj: null, 
                type: 'move', 
                handle: null 
            });

            const svgRef = useRef(null);

            useEffect(() => {
                const cx = snapToGrid(window.innerWidth / 2);
                const cy = 200;
                setObjects([
                    { id: 'line_src', type: 'line', x1: cx - 100, y1: cy, x2: cx + 100, y2: cy, strokeWidth: 2, dash: false },
                    { id: 'txt_src', type: 'text', x: cx - 90, y: cy - 20, text: "Tuyến 475", fontSize: 14, rotate: 0 },
                    { id: 'dev_fco', type: 'icon_device', subType: 'FCO', x: cx, y: cy + 80, label: "03FCO" },
                    { id: 'line_br', type: 'line', x1: cx, y1: cy, x2: cx, y2: cy + 200, strokeWidth: 2, dash: false },
                    { id: 'junc', type: 'circle', cx: cx, cy: cy, r: 4, fill: 'black' },
                    { id: 'load', type: 'icon_load', subType: 'TBA', x: cx, y: cy + 200, label: "TBA 250kVA" }
                ]);
            }, []);

            const screenToWorld = (screenX, screenY) => {
                return {
                    x: (screenX - viewport.x) / viewport.scale,
                    y: (screenY - viewport.y) / viewport.scale
                };
            };

            const handlePointerDown = (e) => {
                if (e.target.closest('button')) return;

                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;

                // CHỈ XỬ LÝ 1 NGÓN TAY (Bỏ qua Multitouch Zoom)
                if (e.touches && e.touches.length > 1) return;

                const targetIsObject = e.target.getAttribute('data-type') === 'object';
                
                if (targetIsObject) {
                    e.stopPropagation();
                    const worldPos = screenToWorld(clientX, clientY);
                    const objId = e.target.getAttribute('data-id');
                    const handleType = e.target.getAttribute('data-handle'); 
                    
                    const obj = objects.find(o => o.id === objId);
                    if (obj) {
                        setSelectedId(objId);
                        setDragState({
                            isDragging: true,
                            draggedId: objId,
                            startX: worldPos.x,
                            startY: worldPos.y,
                            initialObj: { ...obj },
                            type: handleType ? 'resize' : 'move',
                            handle: handleType
                        });
                    }
                } else {
                    // Pan View
                    setIsPanning(true);
                    setLastPanPoint({ x: clientX, y: clientY });
                    setSelectedId(null);
                }
            };

            const handlePointerMove = (e) => {
                e.preventDefault(); 

                // CHỈ XỬ LÝ 1 NGÓN TAY
                if (e.touches && e.touches.length > 1) return;

                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;

                if (isPanning) {
                    const dx = clientX - lastPanPoint.x;
                    const dy = clientY - lastPanPoint.y;
                    setViewport(prev => ({ ...prev, x: prev.x + dx, y: prev.y + dy }));
                    setLastPanPoint({ x: clientX, y: clientY });
                    return;
                }

                if (dragState.isDragging) {
                    const worldPos = screenToWorld(clientX, clientY);
                    const dx = worldPos.x - dragState.startX;
                    const dy = worldPos.y - dragState.startY;
                    const init = dragState.initialObj;

                    setObjects(prev => prev.map(obj => {
                        if (obj.id !== dragState.draggedId) return obj;

                        if (dragState.type === 'resize') {
                            if (obj.type === 'rect_pvlv') {
                                const newW = snapToGrid(init.width + (dragState.handle === 'se' ? dx : 0));
                                const newH = snapToGrid(init.height + (dragState.handle === 'se' ? dy : 0));
                                return { ...obj, width: Math.max(20, newW), height: Math.max(20, newH) };
                            }
                            if (obj.type === 'line') {
                                if (dragState.handle === 'start') return { ...obj, x1: snapToGrid(init.x1 + dx), y1: snapToGrid(init.y1 + dy) };
                                if (dragState.handle === 'end') return { ...obj, x2: snapToGrid(init.x2 + dx), y2: snapToGrid(init.y2 + dy) };
                            }
                            return obj;
                        }

                        if (obj.type === 'line') {
                            return { ...obj, x1: snapToGrid(init.x1 + dx), y1: snapToGrid(init.y1 + dy), x2: snapToGrid(init.x2 + dx), y2: snapToGrid(init.y2 + dy) };
                        } else if (obj.type === 'circle') {
                            return { ...obj, cx: snapToGrid(init.cx + dx), cy: snapToGrid(init.cy + dy) };
                        } else {
                            return { ...obj, x: snapToGrid(init.x + dx), y: snapToGrid(init.y + dy) };
                        }
                    }));
                }
            };

            const handlePointerUp = () => {
                setIsPanning(false);
                setDragState({ ...dragState, isDragging: false });
            };

            const zoomIn = () => setViewport(prev => ({ ...prev, scale: Math.min(prev.scale * 1.2, 3) })); // Zoom nhanh hơn
            const zoomOut = () => setViewport(prev => ({ ...prev, scale: Math.max(prev.scale / 1.2, 0.5) }));

            const addObjectToCenter = (newObj) => {
                const centerX = (window.innerWidth / 2 - viewport.x) / viewport.scale;
                const centerY = (window.innerHeight / 2 - viewport.y) / viewport.scale;
                
                let updatedObj = { ...newObj };
                const cx = snapToGrid(centerX);
                const cy = snapToGrid(centerY);

                if (newObj.type === 'line') {
                    updatedObj.x1 = cx - 60; updatedObj.y1 = cy; updatedObj.x2 = cx + 60; updatedObj.y2 = cy;
                } else if (newObj.type === 'circle') {
                    updatedObj.cx = cx; updatedObj.cy = cy;
                } else {
                    updatedObj.x = cx; updatedObj.y = cy;
                }
                setObjects([...objects, updatedObj]);
                setSelectedId(updatedObj.id);
            };

            const addLine = () => addObjectToCenter({ id: `l_${Date.now()}`, type: 'line', strokeWidth: 2, dash: false });
            const addJunc = () => addObjectToCenter({ id: `j_${Date.now()}`, type: 'circle', r: 4, fill: 'black' });
            const addDevice = (type) => addObjectToCenter({ id: `d_${Date.now()}`, type: 'icon_device', subType: type, label: type === 'FCO' ? "03FCO" : "CB" });
            const addLoad = (type) => addObjectToCenter({ id: `ld_${Date.now()}`, type: 'icon_load', subType: type, label: type === 'TBA' ? "TBA..." : "Tủ..." });
            const addGround = (dir) => addObjectToCenter({ id: `g_${Date.now()}`, type: 'icon_ground', direction: dir });
            const addPVLV = () => addObjectToCenter({ id: `p_${Date.now()}`, type: 'rect_pvlv', width: 120, height: 100 });
            const addText = () => addObjectToCenter({ id: `t_${Date.now()}`, type: 'text', text: "Ghi chú...", fontSize: 14, rotate: 0 });

            const editText = () => {
                const obj = objects.find(o => o.id === selectedId);
                if (!obj) return;
                const current = obj.type === 'text' ? obj.text : obj.label;
                const next = prompt("Nhập nội dung mới:", current);
                if (next !== null) setObjects(prev => prev.map(o => o.id === selectedId ? (o.type === 'text' ? { ...o, text: next } : { ...o, label: next }) : o));
            };
            const toggleDash = () => setObjects(prev => prev.map(o => o.id === selectedId && o.type === 'line' ? { ...o, dash: !o.dash } : o));
            const rotate = () => setObjects(prev => prev.map(o => {
                if (o.id !== selectedId) return o;
                if (o.type === 'line') {
                    const mx = (o.x1+o.x2)/2, my = (o.y1+o.y2)/2, dx = o.x1-mx, dy = o.y1-my;
                    return { ...o, x1: snapToGrid(mx-dy), y1: snapToGrid(my+dx), x2: snapToGrid(mx+dy), y2: snapToGrid(my-dx) };
                }
                return o.type === 'text' ? { ...o, rotate: o.rotate === 0 ? -90 : 0 } : o;
            }));
            const deleteObj = () => { setObjects(objects.filter(o => o.id !== selectedId)); setSelectedId(null); };

            return (
                <div className="flex flex-col h-full bg-gray-200">
                    <div className="bg-blue-600 text-white p-3 shadow-md flex justify-between items-center z-10 shrink-0">
                        <h1 className="text-sm font-bold uppercase flex items-center gap-2"><Icons.Grid /> Sơ Đồ Đơn Tuyến</h1>
                        <button onClick={() => alert("Đã lưu!")} className="text-xs bg-green-500 hover:bg-green-600 px-3 py-1.5 rounded flex items-center gap-1 shadow font-bold active:scale-95"><Icons.Save /> Lưu</button>
                    </div>

                    <div className="bg-white border-b p-2 flex gap-2 overflow-x-auto no-scrollbar shadow-sm shrink-0 items-center z-10">
                        <div className="flex gap-1 border-r pr-2 shrink-0">
                            <button onClick={addLine} className={TOOL_BTN_CLASS}><Icons.Minus /> <span className="text-[9px] mt-1 font-semibold">Dây</span></button>
                            <button onClick={addJunc} className={TOOL_BTN_CLASS}><div className="w-3 h-3 bg-black rounded-full mb-1"></div> <span className="text-[9px] mt-1 font-semibold">Nút</span></button>
                        </div>
                        <div className="flex gap-1 border-r pr-2 shrink-0">
                            <button onClick={() => addDevice('FCO')} className={TOOL_BTN_CLASS}><Icons.Zap /> <span className="text-[9px] mt-1 font-semibold">FCO</span></button>
                            <button onClick={() => addDevice('CB')} className={TOOL_BTN_CLASS}><Icons.Square /> <span className="text-[9px] mt-1 font-semibold">CB</span></button>
                        </div>
                        <div className="flex gap-1 border-r pr-2 shrink-0">
                            <button onClick={() => addLoad('TBA')} className={TOOL_BTN_CLASS}><div className="text-[10px] font-bold border border-gray-600 rounded px-1 mb-1">TBA</div> <span className="text-[9px] font-semibold">MBA</span></button>
                            <button onClick={() => addGround('left')} className={TOOL_BTN_CLASS}>
                                <svg width="14" height="14" viewBox="0 0 16 16" className="mb-1"><line x1="2" y1="2" x2="14" y2="14" stroke="black"/><circle cx="2" cy="2" r="1.5"/></svg>
                                <span className="text-[9px] font-semibold">TĐ(T)</span>
                            </button>
                        </div>
                        <div className="flex gap-1 shrink-0">
                            <button onClick={addPVLV} className={TOOL_BTN_CLASS}><Icons.Square className="text-red-500" strokeWidth="2" strokeDasharray="2 2" /> <span className="text-[9px] mt-1 font-semibold">PVLV</span></button>
                            <button onClick={addText} className={TOOL_BTN_CLASS}><Icons.Type /> <span className="text-[9px] mt-1 font-semibold">Chữ</span></button>
                        </div>
                    </div>

                    <div className="flex-1 overflow-hidden relative cursor-grab active:cursor-grabbing" 
                         onPointerDown={handlePointerDown} 
                         onPointerMove={handlePointerMove} 
                         onPointerUp={handlePointerUp}
                         style={{ cursor: isPanning ? 'grabbing' : 'default' }}>
                        
                        <svg width="100%" height="100%" style={{backgroundColor: 'white'}}>
                            <defs>
                                <pattern id="grid" width={GRID_SIZE} height={GRID_SIZE} patternUnits="userSpaceOnUse"
                                         patternTransform={`translate(${viewport.x} ${viewport.y}) scale(${viewport.scale})`}>
                                    <path d={`M ${GRID_SIZE} 0 L 0 0 0 ${GRID_SIZE}`} fill="none" stroke={COLORS.grid} strokeWidth="1"/>
                                </pattern>
                            </defs>
                            
                            <rect width="100%" height="100%" fill="url(#grid)" />

                            <g transform={`translate(${viewport.x}, ${viewport.y}) scale(${viewport.scale})`}>
                                {objects.map(obj => {
                                    const isSelected = obj.id === selectedId;
                                    
                                    if (obj.type === 'line') return (
                                        <g key={obj.id} data-id={obj.id} data-type="object">
                                            <line x1={obj.x1} y1={obj.y1} x2={obj.x2} y2={obj.y2} stroke="black" strokeWidth={obj.strokeWidth} strokeDasharray={obj.dash ? "5,5" : "none"} pointerEvents="none" />
                                            <line x1={obj.x1} y1={obj.y1} x2={obj.x2} y2={obj.y2} stroke="transparent" strokeWidth="20" data-id={obj.id} data-type="object" />
                                            {isSelected && <line x1={obj.x1} y1={obj.y1} x2={obj.x2} y2={obj.y2} stroke={COLORS.highlight} strokeWidth="1" strokeDasharray="2 2" pointerEvents="none"/>}
                                            {isSelected && <circle cx={obj.x1} cy={obj.y1} r="8" fill={COLORS.highlight} fillOpacity="0.5" data-id={obj.id} data-type="object" data-handle="start" />}
                                            {isSelected && <circle cx={obj.x2} cy={obj.y2} r="8" fill={COLORS.highlight} fillOpacity="0.5" data-id={obj.id} data-type="object" data-handle="end" />}
                                        </g>
                                    );

                                    if (obj.type === 'circle') return (
                                        <circle key={obj.id} cx={obj.cx} cy={obj.cy} r={isSelected ? 6 : 4} fill={isSelected ? COLORS.highlight : "black"} 
                                                data-id={obj.id} data-type="object" />
                                    );
                                    
                                    if (obj.type === 'icon_device') return (
                                        <g key={obj.id} transform={`translate(${obj.x}, ${obj.y})`} data-id={obj.id} data-type="object">
                                            <rect x="-20" y="-20" width="40" height="40" fill="transparent" data-id={obj.id} data-type="object"/>
                                            {obj.subType === 'FCO' ? <g pointerEvents="none" stroke="black" strokeWidth="2"><rect x="-8" y="-15" width="16" height="30" fill="white"/><line x1="-8" y1="-15" x2="15" y2="-25"/><circle cx="15" cy="-25" r="2" fill="white"/></g> 
                                            : <g pointerEvents="none" stroke="black" strokeWidth="2"><rect x="-15" y="-15" width="30" height="30" fill="white"/><line x1="-15" y1="-15" x2="15" y2="15"/><line x1="15" y1="-15" x2="-15" y2="15"/></g>}
                                            <text x="20" y="5" fontSize="12" fontWeight="bold" pointerEvents="none">{obj.label}</text>
                                            {isSelected && <rect x="-22" y="-22" width="44" height="44" fill="none" stroke={COLORS.highlight} strokeWidth="2" strokeDasharray="3 3" pointerEvents="none"/>}
                                        </g>
                                    );

                                    if (obj.type === 'icon_load') return (
                                        <g key={obj.id} transform={`translate(${obj.x}, ${obj.y})`} data-id={obj.id} data-type="object">
                                            <rect x="-25" y="-25" width="50" height="50" fill="transparent" data-id={obj.id} data-type="object"/>
                                            {obj.subType === 'TBA' ? <g pointerEvents="none" stroke="black" strokeWidth="2" fill="none"><circle cx="0" cy="-8" r="14" fill="white"/><circle cx="0" cy="8" r="14" fill="white"/></g>
                                            : <rect pointerEvents="none" x="-18" y="-25" width="36" height="50" fill="white" stroke="black" strokeWidth="2"/>}
                                            <text x="25" y="5" fontSize="12" fontWeight="bold" pointerEvents="none">{obj.label}</text>
                                            {isSelected && <rect x="-28" y="-28" width="56" height="56" fill="none" stroke={COLORS.highlight} strokeWidth="2" strokeDasharray="3 3" pointerEvents="none"/>}
                                        </g>
                                    );

                                    if (obj.type === 'icon_ground') {
                                        const dx = obj.direction === 'left' ? -20 : 20, dy = -20;
                                        return (
                                            <g key={obj.id} transform={`translate(${obj.x}, ${obj.y})`} data-id={obj.id} data-type="object">
                                                <rect x="-25" y="-25" width="50" height="35" fill="transparent" data-id={obj.id} data-type="object"/>
                                                <g pointerEvents="none">
                                                    <line x1={dx} y1={dy} x2="0" y2="0" stroke="black" strokeWidth="2"/><circle cx={dx} cy={dy} r="3" fill="black"/>
                                                    <line x1="-15" y1="0" x2="15" y2="0" stroke="black" strokeWidth="2"/><line x1="-10" y1="4" x2="10" y2="4" stroke="black" strokeWidth="2"/><line x1="-5" y1="8" x2="5" y2="8" stroke="black" strokeWidth="2"/>
                                                </g>
                                                {isSelected && <rect x="-25" y="-25" width="50" height="35" fill="none" stroke={COLORS.highlight} strokeWidth="2" strokeDasharray="3 3" pointerEvents="none"/>}
                                            </g>
                                        );
                                    }

                                    if (obj.type === 'text') return (
                                        <text key={obj.id} x={obj.x} y={obj.y} fontSize={obj.fontSize} fill={isSelected ? COLORS.highlight : "black"} 
                                              transform={`rotate(${obj.rotate || 0}, ${obj.x}, ${obj.y})`}
                                              style={{fontWeight: isSelected ? 'bold' : 'normal'}}
                                              data-id={obj.id} data-type="object">
                                            {obj.text}
                                        </text>
                                    );

                                    if (obj.type === 'rect_pvlv') return (
                                        <g key={obj.id} transform={`translate(${obj.x}, ${obj.y})`} data-id={obj.id} data-type="object">
                                            <rect width={obj.width} height={obj.height} fill="rgba(239, 68, 68, 0.05)" stroke={COLORS.pvlv} strokeWidth="2" strokeDasharray="5 5" data-id={obj.id} data-type="object"/>
                                            <text x="5" y="15" fill={COLORS.pvlv} fontSize="10" fontWeight="bold" pointerEvents="none">PVLV</text>
                                            {isSelected && <rect x={obj.width - 20} y={obj.height - 20} width="20" height="20" fill="white" stroke={COLORS.highlight} strokeWidth="2" data-id={obj.id} data-type="object" data-handle="se" />}
                                        </g>
                                    );
                                    return null;
                                })}
                            </g>
                        </svg>

                        <div className="absolute top-4 right-4 flex flex-col gap-3">
                            <button onClick={zoomIn} className="w-10 h-10 bg-white rounded-full shadow-md flex items-center justify-center text-gray-700 active:bg-gray-100"><Icons.ZoomIn/></button>
                            <button onClick={zoomOut} className="w-10 h-10 bg-white rounded-full shadow-md flex items-center justify-center text-gray-700 active:bg-gray-100"><Icons.ZoomOut/></button>
                        </div>
                    </div>

                    {selectedId && (
                        <div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-white px-4 py-3 rounded-full shadow-2xl border border-gray-200 flex items-center gap-3 animate-slide-up z-50 overflow-x-auto max-w-[90%] no-scrollbar">
                            
                            {['text', 'icon_device', 'icon_load'].includes(objects.find(o => o.id === selectedId)?.type) && (
                                <button onClick={editText} className={ACTION_BTN_CLASS + " text-orange-600 border-orange-200"}>
                                     <Icons.Edit/> Sửa
                                </button>
                            )}

                            {(objects.find(o => o.id === selectedId)?.type === 'text' || objects.find(o => o.id === selectedId)?.type === 'line') && (
                                <button onClick={rotate} className={ACTION_BTN_CLASS + " text-purple-600 border-purple-200"}>
                                    <Icons.RotateCcw/> Xoay
                                </button>
                            )}

                            {objects.find(o => o.id === selectedId)?.type === 'line' && (
                                <button onClick={toggleDash} className={ACTION_BTN_CLASS + " text-blue-600 border-blue-200"}>
                                     <Icons.Minus/> Đứt/Liền
                                </button>
                            )}

                            <div className="w-[1px] h-6 bg-gray-300 mx-1"></div>

                            <button onClick={deleteObj} className={ACTION_BTN_CLASS + " text-red-600 border-red-200 bg-red-50"}>
                                <Icons.Trash2/> Xóa
                            </button>
                            
                            <button onClick={() => setSelectedId(null)} className="p-2 text-gray-400 hover:text-gray-600">
                                <Icons.X />
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
