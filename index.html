<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kh·∫£o S√°t Hi·ªán Tr∆∞·ªùng Ver 4.2</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body { font-family: 'Times New Roman', sans-serif; background-color: #f3f4f6; }
        .a4-paper { background: white; max-width: 210mm; margin: 0 auto; padding: 10mm; box-shadow: 0 0 10px rgba(0,0,0,0.1); min-height: 297mm; }
        input, textarea, select { font-family: 'Times New Roman', sans-serif; }
        @media (max-width: 768px) { .a4-paper { padding: 15px; width: 100%; max-width: 100%; } body { background-color: white; } }
        .input-line { border: none; border-bottom: 1px dotted #9ca3af; width: 100%; outline: none; background: transparent; padding: 2px 0; color: #1f2937; font-weight: 500; }
        .input-line:focus { border-bottom: 1px solid #2563eb; }
        .section-title { font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; font-size: 14px; }
        th, td { border: 1px solid #d1d5db; padding: 8px; text-align: left; vertical-align: top; }
        th { background-color: #f9fafb; font-weight: bold; text-align: center; }
        .tag-btn { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 9999px; font-size: 12px; font-weight: 500; background-color: #eff6ff; color: #1d4ed8; border: 1px solid #bfdbfe; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .tag-btn:active { transform: scale(0.95); background-color: #dbeafe; }
        .no-scrollbar::-webkit-scrollbar { display: none; } .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .camera-btn { background: #e0f2fe; border: 2px dashed #3b82f6; color: #1d4ed8; transition: all 0.2s; }
        .camera-btn:hover { background: #dbeafe; border-color: #2563eb; }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-zoom-in { animation: zoomIn 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    </style>
</head>
<body>

<div id="root"></div>

<script>
    window.onerror = function(msg, src, line) { 
        if(msg.includes("ResizeObserver")) return;
        document.body.innerHTML = '<div style="padding:20px;color:red;font-size:16px"><h2>L·ªói h·ªá th·ªëng!</h2><p>' + msg + '</p><p>D√≤ng: ' + line + '</p></div>'; 
    };
</script>

<script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;
    const supabaseUrl = 'https://wvcjrmcahndwenqnkdim.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind2Y2pybWNhaG5kd2VucW5rZGltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5NTI4NjQsImV4cCI6MjA4NDUyODg2NH0.GoacKpBBCut6yhmYUWTLeAdbsGwzJSR2AQJrON5mEvM'
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// --- COMPONENT ƒêƒÇNG NH·∫¨P ---
    const LoginScreen = ({ onLogin, loading }) => {
        const [user, setUser] = useState("");
        const [pass, setPass] = useState("");
        const handleEnter = (e) => { if(e.key === 'Enter') onLogin(user, pass); };

        return (
            <div className="fixed inset-0 bg-gray-100 flex flex-col items-center justify-center z-[9999]">
                <div className="bg-white p-8 rounded-xl shadow-xl w-80 border">
                    <h2 className="text-xl font-bold text-center mb-6 text-blue-800 uppercase">ƒêƒÉng Nh·∫≠p</h2>
                    <div className="space-y-4">
                        <input className="w-full border p-2 rounded outline-none focus:border-blue-500" placeholder="T√™n ƒëƒÉng nh·∫≠p" value={user} onChange={e=>setUser(e.target.value)} onKeyDown={handleEnter} />
                        <input type="password" className="w-full border p-2 rounded outline-none focus:border-blue-500" placeholder="M·∫≠t kh·∫©u" value={pass} onChange={e=>setPass(e.target.value)} onKeyDown={handleEnter} />
                        <button onClick={() => onLogin(user, pass)} disabled={loading} className="w-full bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-700 transition-colors">
                            {loading ? "ƒêang ki·ªÉm tra..." : "ƒêƒÇNG NH·∫¨P"}
                        </button>
                    </div>
                </div>
            </div>
        );
    };


    const UI_Icons = {
        Save: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>,
        Plus: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
        Trash2: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>,
        FileText: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>,
        Share2: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>,
        X: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
        FolderOpen: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>,
        CheckSquare: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>,
        Download: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>,
        Database: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s 9-1.34 9-3V5"></path></svg>,
        Minus: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
        Zap: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>,
        ZapFill: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>,
        Square: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>,
        Type: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg>,
        RotateCcw: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 4v6h6"></path><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>,
        Edit: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
        Grid: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>,
        ZoomIn: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>,
        ZoomOut: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>,
        Target: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="2"></circle></svg>,
        Image: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
    };

// --- MODULE V·∫º S∆† ƒê·ªí (ƒê√É S·ª¨A L·ªñI V3.3) ---
    const GRID_SIZE = 5;
    const COLORS = { wire: '#000000', grid: '#e2e8f0', pvlv: '#ef4444', highlight: '#3b82f6', text: '#000000' };
    
    // ƒê·ªäNH NGHƒ®A CSS CLASS (S·ª≠a l·ªói ReferenceError)
    const TOOL_BTN_CLASS = "flex flex-col items-center justify-center px-2 py-1 rounded border border-transparent hover:bg-gray-100 min-w-[55px] transition-colors cursor-pointer active:bg-gray-200 touch-manipulation";
    const ACTION_BTN_CLASS = "flex items-center gap-2 border px-3 py-2 rounded-full shadow-md bg-white hover:bg-gray-50 transition-all active:scale-95 cursor-pointer text-sm font-medium whitespace-nowrap touch-manipulation";
    
    const snapToGrid = (val) => Math.round(val / GRID_SIZE) * GRID_SIZE;
    
// --- COMPONENT TR√åNH V·∫º S∆† ƒê·ªí (ƒê√É S·ª¨A: T·ª∞ ƒê·ªòNG CƒÇN GI·ªÆA TR√äN MOBILE) ---
    const DiagramEditor = ({ initialData, onSave, onClose }) => {
        const [objects, setObjects] = useState(initialData || []);
        const [selectedId, setSelectedId] = useState(null);
        const [showTemplateModal, setShowTemplateModal] = useState(false);
        const [templates, setTemplates] = useState([]);
        const [loadingTemplates, setLoadingTemplates] = useState(false);
        const [viewport, setViewport] = useState({ x: 0, y: 0, scale: 1 });
        const [isPanning, setIsPanning] = useState(false);
        const [lastPanPoint, setLastPanPoint] = useState({ x: 0, y: 0 });
        const [dragState, setDragState] = useState({ isDragging: false, draggedId: null, startX: 0, startY: 0, initialObj: null, type: 'move', handle: null });

        // --- H√ÄM M·ªöI: T·ª∞ ƒê·ªòNG CƒÇN GI·ªÆA & CO GI√ÉN (AUTO FIT) ---
        const fitToScreen = (items) => {
            if (!items || items.length === 0) {
                // N·∫øu kh√¥ng c√≥ h√¨nh, v·ªÅ gi·ªØa m√†n h√¨nh
                setViewport({ x: window.innerWidth / 2, y: window.innerHeight / 2, scale: 1 });
                return;
            }

            // 1. T√¨m bi√™n (bounds) c·ªßa t·∫•t c·∫£ h√¨nh v·∫Ω
            let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
            
            items.forEach(obj => {
                if (obj.type === 'line') {
                    minX = Math.min(minX, obj.x1, obj.x2); maxX = Math.max(maxX, obj.x1, obj.x2);
                    minY = Math.min(minY, obj.y1, obj.y2); maxY = Math.max(maxY, obj.y1, obj.y2);
                } else if (obj.type === 'rect_pvlv') {
                    minX = Math.min(minX, obj.x); maxX = Math.max(maxX, obj.x + obj.width);
                    minY = Math.min(minY, obj.y); maxY = Math.max(maxY, obj.y + obj.height);
                } else {
                    // C√°c icon, text, circle (t√¢m cx, cy ho·∫∑c x, y)
                    const x = obj.x !== undefined ? obj.x : obj.cx;
                    const y = obj.y !== undefined ? obj.y : obj.cy;
                    const size = 40; // K√≠ch th∆∞·ªõc ∆∞·ªõc l∆∞·ª£ng
                    minX = Math.min(minX, x - size); maxX = Math.max(maxX, x + size);
                    minY = Math.min(minY, y - size); maxY = Math.max(maxY, y + size);
                }
            });

            // 2. T√≠nh to√°n t·ª∑ l·ªá zoom v√† v·ªã tr√≠
            const padding = 40; // Kho·∫£ng c√°ch l·ªÅ
            const contentWidth = maxX - minX + padding * 2;
            const contentHeight = maxY - minY + padding * 2;
            
            const screenW = window.innerWidth;
            const screenH = window.innerHeight - 100; // Tr·ª´ hao thanh c√¥ng c·ª•
            
            // T√≠nh scale sao cho v·ª´a kh√≠t
            let newScale = Math.min(screenW / contentWidth, screenH / contentHeight);
            newScale = Math.min(newScale, 1.2); // Kh√¥ng zoom qu√° to (max 1.2)
            newScale = Math.max(newScale, 0.3); // Kh√¥ng qu√° nh·ªè
            
            // T√≠nh to√°n v·ªã tr√≠ ƒë·ªÉ ƒë∆∞a v·ªÅ gi·ªØa m√†n h√¨nh
            const contentCenterX = (minX + maxX) / 2;
            const contentCenterY = (minY + maxY) / 2;
            
            const newX = (screenW / 2) - (contentCenterX * newScale);
            const newY = (screenH / 2) - (contentCenterY * newScale);

            setViewport({ x: newX, y: newY, scale: newScale });
        };

        // Khi m·ªü l√™n, n·∫øu c√≥ d·ªØ li·ªáu c≈© -> T·ª± ƒë·ªông Fit
        useEffect(() => {
            if (initialData && initialData.length > 0) {
                // Delay nh·∫π ƒë·ªÉ DOM render xong m·ªõi t√≠nh to√°n chu·∫©n k√≠ch th∆∞·ªõc m√†n h√¨nh
                setTimeout(() => fitToScreen(initialData), 50);
            } else {
                // N·∫øu t·∫°o m·ªõi, ƒë·∫∑t t√¢m ·ªü gi·ªØa m√†n h√¨nh
                const cx = snapToGrid(window.innerWidth / 2);
                const cy = snapToGrid(window.innerHeight / 2 - 50);
                
                // T·∫°o m·∫´u m·∫∑c ƒë·ªãnh n·∫±m ngay gi·ªØa
                setObjects([
                    { id: 'line_src', type: 'line', x1: cx - 80, y1: cy, x2: cx + 80, y2: cy, strokeWidth: 2, dash: false },
                    { id: 'txt_src', type: 'text', x: cx, y: cy - 20, text: "Tuy·∫øn...", fontSize: 14, rotate: 0 },
                    { id: 'dev_fco', type: 'icon_device', subType: 'FCO', x: cx, y: cy + 60, label: "FCO" },
                    { id: 'line_br', type: 'line', x1: cx, y1: cy, x2: cx, y2: cy + 150, strokeWidth: 2, dash: false },
                    { id: 'junc', type: 'circle', cx: cx, cy: cy, r: 4, fill: 'black' },
                    { id: 'load', type: 'icon_load', subType: 'TBA', x: cx, y: cy + 150, label: "TBA..." }
               ]);
               // Reset viewport v·ªÅ 0,0 (v√¨ ƒë√£ t√≠nh t·ªça ƒë·ªô cx, cy theo m√†n h√¨nh r·ªìi)
               setViewport({ x: 0, y: 0, scale: 1 });
            }
        }, []);
        
        const fetchTemplates = async () => {
            setLoadingTemplates(true);
            let localTemplates = [];
            try { const local = localStorage.getItem('local_diagram_templates'); if (local) localTemplates = JSON.parse(local); } catch(e) {}
            let cloudTemplates = [];
            try { const { data, error } = await supabase.from('diagram_templates').select('*').order('created_at', { ascending: false }); if (!error && data) cloudTemplates = data; } catch(e) {}
            setTemplates([...localTemplates, ...cloudTemplates]);
            setLoadingTemplates(false);
        };
        const handleSaveTemplate = async () => {
            const name = prompt("Nh·∫≠p t√™n m·∫´u ƒë·ªÉ l∆∞u:"); if (!name) return;
            const newTplData = { name: name, data: objects };
            try {
                const local = JSON.parse(localStorage.getItem('local_diagram_templates') || '[]');
                const localTpl = { ...newTplData, id: 'local_' + Date.now(), created_at: new Date().toISOString() };
                local.unshift(localTpl); localStorage.setItem('local_diagram_templates', JSON.stringify(local));
                supabase.from('diagram_templates').insert([newTplData]).then(({ error }) => { if (error) console.warn("Cloud save failed:", error.message); });
                alert("ƒê√£ l∆∞u m·∫´u th√†nh c√¥ng!"); fetchTemplates();
            } catch (e) { alert("L·ªói l∆∞u m·∫´u: " + e.message); }
        };
        const handleDeleteTemplate = async (id, e) => {
            e.stopPropagation(); if(!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m·∫´u n√†y?")) return;
            if (String(id).startsWith('local_')) {
                const local = JSON.parse(localStorage.getItem('local_diagram_templates') || '[]');
                localStorage.setItem('local_diagram_templates', JSON.stringify(local.filter(t => t.id !== id))); fetchTemplates();
            } else { await supabase.from('diagram_templates').delete().eq('id', id); fetchTemplates(); }
        };
        
        // --- C·∫¨P NH·∫¨T H√ÄM LOAD M·∫™U: G·ªçi fitToScreen ---
        const handleLoadTemplate = (tpl) => { 
            if(confirm(`D√πng m·∫´u "${tpl.name}"?`)) { 
                setObjects(tpl.data); 
                setShowTemplateModal(false);
                // T·ª± ƒë·ªông cƒÉn gi·ªØa sau khi load
                setTimeout(() => fitToScreen(tpl.data), 50);
            } 
        };

        const openTemplateModal = () => { setShowTemplateModal(true); fetchTemplates(); };
        const screenToWorld = (screenX, screenY) => ({ x: (screenX - viewport.x) / viewport.scale, y: (screenY - viewport.y) / viewport.scale });
        
        const handlePointerDown = (e) => {
            if (e.target.closest('button')) return;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            if (e.touches && e.touches.length > 1) return;
            const targetIsObject = e.target.getAttribute('data-type') === 'object';
            if (targetIsObject) {
                e.stopPropagation(); const worldPos = screenToWorld(clientX, clientY); const objId = e.target.getAttribute('data-id'); const handleType = e.target.getAttribute('data-handle'); const obj = objects.find(o => o.id === objId);
                if (obj) { setSelectedId(objId); setDragState({ isDragging: true, draggedId: objId, startX: worldPos.x, startY: worldPos.y, initialObj: { ...obj }, type: handleType ? 'resize' : 'move', handle: handleType }); }
            } else { setIsPanning(true); setLastPanPoint({ x: clientX, y: clientY }); setSelectedId(null); }
        };
        const handlePointerMove = (e) => {
            e.preventDefault(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            if (e.touches && e.touches.length > 1) { setLastPanPoint({ x: clientX, y: clientY }); return; }
            if (isPanning) { const dx = clientX - lastPanPoint.x; const dy = clientY - lastPanPoint.y; setViewport(prev => ({ ...prev, x: prev.x + dx, y: prev.y + dy })); setLastPanPoint({ x: clientX, y: clientY }); return; }
            if (dragState.isDragging) {
                const worldPos = screenToWorld(clientX, clientY); const dx = worldPos.x - dragState.startX; const dy = worldPos.y - dragState.startY; const init = dragState.initialObj;
                setObjects(prev => prev.map(obj => { if (obj.id !== dragState.draggedId) return obj;
                    if (dragState.type === 'resize') { if (obj.type === 'rect_pvlv') { const newW = snapToGrid(init.width + (dragState.handle === 'se' ? dx : 0)); const newH = snapToGrid(init.height + (dragState.handle === 'se' ? dy : 0)); return { ...obj, width: Math.max(20, newW), height: Math.max(20, newH) }; } if (obj.type === 'line') { if (dragState.handle === 'start') return { ...obj, x1: snapToGrid(init.x1 + dx), y1: snapToGrid(init.y1 + dy) }; if (dragState.handle === 'end') return { ...obj, x2: snapToGrid(init.x2 + dx), y2: snapToGrid(init.y2 + dy) }; } return obj; }
                    if (obj.type === 'line') return { ...obj, x1: snapToGrid(init.x1 + dx), y1: snapToGrid(init.y1 + dy), x2: snapToGrid(init.x2 + dx), y2: snapToGrid(init.y2 + dy) }; else if (obj.type === 'circle') return { ...obj, cx: snapToGrid(init.cx + dx), cy: snapToGrid(init.cy + dy) }; else return { ...obj, x: snapToGrid(init.x + dx), y: snapToGrid(init.y + dy) };
                }));
            }
        };
        const handlePointerUp = () => { setIsPanning(false); setDragState({ ...dragState, isDragging: false }); };
        const addObjectToCenter = (newObj) => { const centerX = (window.innerWidth / 2 - viewport.x) / viewport.scale; const centerY = (window.innerHeight / 2 - viewport.y) / viewport.scale; let updatedObj = { ...newObj }; const cx = snapToGrid(centerX); const cy = snapToGrid(centerY); if (newObj.type === 'line') { updatedObj.x1 = cx - 60; updatedObj.y1 = cy; updatedObj.x2 = cx + 60; updatedObj.y2 = cy; } else if (newObj.type === 'circle') { updatedObj.cx = cx; updatedObj.cy = cy; } else { updatedObj.x = cx; updatedObj.y = cy; } setObjects([...objects, updatedObj]); setSelectedId(updatedObj.id); };
        
        return (
            <div className="fixed inset-0 z-[100] bg-gray-200 flex flex-col h-full w-full" style={{touchAction: 'none'}}>
                {showTemplateModal && (<div className="fixed inset-0 bg-black/50 z-[110] flex items-center justify-center p-4" onClick={() => setShowTemplateModal(false)}><div className="bg-white rounded-lg w-full max-w-md shadow-xl flex flex-col max-h-[80vh]" onClick={e => e.stopPropagation()}><div className="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg"><h3 className="font-bold text-lg flex items-center gap-2"><UI_Icons.FolderOpen /> Danh s√°ch M·∫´u</h3><button onClick={() => setShowTemplateModal(false)} className="p-1 hover:bg-gray-200 rounded"><UI_Icons.X /></button></div><div className="p-4 border-b bg-blue-50"><button onClick={handleSaveTemplate} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded flex items-center justify-center gap-2"><UI_Icons.Save /> L∆∞u s∆° ƒë·ªì hi·ªán t·∫°i th√†nh M·∫´u m·ªõi</button></div><div className="overflow-y-auto p-4 space-y-2 flex-1">{loadingTemplates ? <div className="text-center text-gray-500">ƒêang t·∫£i...</div> : (templates.length === 0 ? <div className="text-center text-gray-400 italic">Ch∆∞a c√≥ m·∫´u n√†o</div> : templates.map(t => (<div key={t.id} onClick={() => handleLoadTemplate(t)} className="flex items-center justify-between p-3 border rounded hover:bg-gray-100 cursor-pointer group transition-colors"><span className="font-medium text-gray-800">{t.name}</span><button onClick={(e) => handleDeleteTemplate(t.id, e)} className="text-gray-400 hover:text-red-600 p-1"><UI_Icons.Trash2 /></button></div>)))}</div><div className="p-3 border-t bg-gray-50 flex justify-end"><button onClick={() => setShowTemplateModal(false)} className="px-4 py-2 bg-white border border-gray-300 rounded hover:bg-gray-100 text-sm font-medium">ƒê√≥ng</button></div></div></div>)}
                <div className="bg-blue-600 text-white p-3 shadow-md flex justify-between items-center z-10 shrink-0"><h1 className="text-sm font-bold uppercase flex items-center gap-2"><UI_Icons.Grid /> Tr√¨nh V·∫Ω S∆° ƒê·ªì</h1><button onClick={openTemplateModal} className="bg-yellow-400 hover:bg-yellow-500 text-blue-900 px-3 py-1.5 rounded flex items-center gap-1 shadow font-bold text-xs"><UI_Icons.FolderOpen /> üìÇ M·∫´u S∆° ƒê·ªì</button><div className="flex gap-2"><button onClick={onClose} className="text-xs bg-white text-gray-700 hover:bg-gray-100 px-3 py-1.5 rounded flex items-center gap-1 shadow font-bold">Tho√°t</button><button onClick={() => { onSave(objects); onClose(); }} className="text-xs bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded flex items-center gap-1 shadow font-bold"><UI_Icons.Save /> L∆∞u</button></div></div>
                <div className="bg-white border-b p-2 flex gap-2 overflow-x-auto no-scrollbar shadow-sm shrink-0 items-center z-10">
                    <div className="flex gap-1 border-r pr-2 shrink-0"><button onClick={() => addObjectToCenter({ id: `l_${Date.now()}`, type: 'line', strokeWidth: 2, dash: false })} className={TOOL_BTN_CLASS}><UI_Icons.Minus /> <span className="text-[9px] mt-1 font-semibold">D√¢y</span></button><button onClick={() => addObjectToCenter({ id: `j_${Date.now()}`, type: 'circle', r: 4, fill: 'black' })} className={TOOL_BTN_CLASS}><div className="w-3 h-3 bg-black rounded-full mb-1"></div> <span className="text-[9px] mt-1 font-semibold">N√∫t</span></button></div>
                    <div className="flex gap-1 border-r pr-2 shrink-0"><button onClick={() => addObjectToCenter({ id: `d_${Date.now()}`, type: 'icon_device', subType: 'FCO', label: "03FCO" })} className={TOOL_BTN_CLASS}><UI_Icons.Zap /> <span className="text-[9px] mt-1 font-semibold">FCO</span></button><button onClick={() => addObjectToCenter({ id: `d_${Date.now()}`, type: 'icon_device', subType: 'LBFCO', label: "03LBFCO" })} className={TOOL_BTN_CLASS}><UI_Icons.ZapFill /> <span className="text-[9px] mt-1 font-semibold">LBFCO</span></button></div>
                    <div className="flex gap-1 border-r pr-2 shrink-0"><button onClick={() => addObjectToCenter({ id: `ld_${Date.now()}`, type: 'icon_load', subType: 'TBA', label: "TBA..." })} className={TOOL_BTN_CLASS}><div className="text-[10px] font-bold border border-gray-600 rounded px-1 mb-1">TBA</div> <span className="text-[9px] font-semibold">MBA</span></button><button onClick={() => addObjectToCenter({ id: `g_${Date.now()}`, type: 'icon_ground', direction: 'left' })} className={TOOL_BTN_CLASS}><svg width="14" height="14" viewBox="0 0 16 16" className="mb-1"><line x1="2" y1="2" x2="14" y2="14" stroke="black"/><circle cx="2" cy="2" r="1.5"/></svg><span className="text-[9px] font-semibold">Tƒê(T)</span></button><button onClick={() => addObjectToCenter({ id: `g_${Date.now()}`, type: 'icon_ground', direction: 'right' })} className={TOOL_BTN_CLASS}><svg width="14" height="14" viewBox="0 0 16 16" className="mb-1"><line x1="14" y1="2" x2="2" y2="14" stroke="black"/><circle cx="14" cy="2" r="1.5"/></svg><span className="text-[9px] font-semibold">Tƒê(P)</span></button><button onClick={() => addObjectToCenter({ id: `glv_${Date.now()}`, type: 'icon_ground_lv', direction: 'left' })} className={TOOL_BTN_CLASS}><svg width="14" height="14" viewBox="0 0 16 16" className="mb-1"><circle cx="12" cy="2" r="1.5" fill="black"/><line x1="12" y1="2" x2="6" y2="8" stroke="black" strokeWidth="1.5"/><line x1="2" y1="8" x2="10" y2="8" stroke="black" strokeWidth="1.5"/><line x1="4" y1="11" x2="8" y2="11" stroke="black" strokeWidth="1.5"/></svg><span className="text-[9px] font-semibold">HT(T)</span></button><button onClick={() => addObjectToCenter({ id: `glv_${Date.now()}`, type: 'icon_ground_lv', direction: 'right' })} className={TOOL_BTN_CLASS}><svg width="14" height="14" viewBox="0 0 16 16" className="mb-1"><circle cx="2" cy="2" r="1.5" fill="black"/><line x1="2" y1="2" x2="8" y2="8" stroke="black" strokeWidth="1.5"/><line x1="4" y1="8" x2="12" y2="8" stroke="black" strokeWidth="1.5"/><line x1="6" y1="11" x2="10" y2="11" stroke="black" strokeWidth="1.5"/></svg><span className="text-[9px] font-semibold">HT(P)</span></button></div>
                    <div className="flex gap-1 shrink-0"><button onClick={() => addObjectToCenter({ id: `p_${Date.now()}`, type: 'rect_pvlv', width: 120, height: 100 })} className={TOOL_BTN_CLASS}><UI_Icons.Square className="text-red-500" strokeWidth="2" strokeDasharray="2 2" /> <span className="text-[9px] mt-1 font-semibold">PVLV</span></button><button onClick={() => addObjectToCenter({ id: `t_${Date.now()}`, type: 'text', text: "Ghi ch√∫...", fontSize: 14, rotate: 0 })} className={TOOL_BTN_CLASS}><UI_Icons.Type /> <span className="text-[9px] mt-1 font-semibold">Ch·ªØ</span></button></div>
                </div>
                <div className="flex-1 overflow-hidden relative cursor-grab active:cursor-grabbing" onPointerDown={handlePointerDown} onPointerMove={handlePointerMove} onPointerUp={handlePointerUp} style={{ cursor: isPanning ? 'grabbing' : 'default' }}>
                    <svg width="100%" height="100%" style={{backgroundColor: 'white'}}>
                        <defs>
                            <pattern id="grid" width={GRID_SIZE} height={GRID_SIZE} patternUnits="userSpaceOnUse" patternTransform={`translate(${viewport.x} ${viewport.y}) scale(${viewport.scale})`}>
                                <path d={`M ${GRID_SIZE} 0 L 0 0 0 ${GRID_SIZE}`} fill="none" stroke={COLORS.grid} strokeWidth="0.5"/>
                            </pattern>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#grid)" />
                        <g transform={`translate(${viewport.x}, ${viewport.y}) scale(${viewport.scale})`}>
                            {objects.map(obj => {
                                const isSelected = obj.id === selectedId;
                                if (obj.type === 'line') return (<g key={obj.id} data-id={obj.id} data-type="object"><line x1={obj.x1} y1={obj.y1} x2={obj.x2} y2={obj.y2} stroke="black" strokeWidth={obj.strokeWidth} strokeDasharray={obj.dash ? "5,5" : "none"} pointerEvents="none" /><line x1={obj.x1} y1={obj.y1} x2={obj.x2} y2={obj.y2} stroke="transparent" strokeWidth="20" data-id={obj.id} data-type="object" />{isSelected && <line x1={obj.x1} y1={obj.y1} x2={obj.x2} y2={obj.y2} stroke={COLORS.highlight} strokeWidth="1" strokeDasharray="2 2" pointerEvents="none"/>}{isSelected && <circle cx={obj.x1} cy={obj.y1} r="8" fill={COLORS.highlight} fillOpacity="0.5" data-id={obj.id} data-type="object" data-handle="start" />}{isSelected && <circle cx={obj.x2} cy={obj.y2} r="8" fill={COLORS.highlight} fillOpacity="0.5" data-id={obj.id} data-type="object" data-handle="end" />}</g>); 
                                if (obj.type === 'circle') return (<circle key={obj.id} cx={obj.cx} cy={obj.cy} r={isSelected ? 6 : 4} fill={isSelected ? COLORS.highlight : "black"} data-id={obj.id} data-type="object" />); 
                                if (obj.type === 'icon_device') return (<g key={obj.id} transform={`translate(${obj.x}, ${obj.y})`} data-id={obj.id} data-type="object"><rect x="-20" y="-20" width="40" height="40" fill="transparent" data-id={obj.id} data-type="object"/>{['FCO', 'LBFCO'].includes(obj.subType) ? (<g pointerEvents="none" stroke="black" strokeWidth="2" fill="none"><line x1="-20" y1="-20" x2="20" y2="20"/><path d="M -20 -20 A 18 18 0 0 1 0 0" fill="none" stroke="black" strokeWidth="2"/><path d="M 0 0 A 18 18 0 0 0 20 20" fill={obj.subType === 'LBFCO' ? "black" : "none"} /></g>) : (<g pointerEvents="none" stroke="black" strokeWidth="2"><rect x="-15" y="-15" width="30" height="30" fill="white"/><line x1="-15" y1="-15" x2="15" y2="15"/><line x1="15" y1="-15" x2="-15" y2="15"/></g>)}<text x="20" y="5" fontSize="12" fontWeight="bold" pointerEvents="none">{obj.label}</text>{isSelected && <rect x="-22" y="-22" width="44" height="44" fill="none" stroke={COLORS.highlight} strokeWidth="2" strokeDasharray="3 3" pointerEvents="none"/>}</g>); 
                                if (obj.type === 'icon_load') return (<g key={obj.id} transform={`translate(${obj.x}, ${obj.y})`} data-id={obj.id} data-type="object"><rect x="-25" y="-25" width="50" height="50" fill="transparent" data-id={obj.id} data-type="object"/>{obj.subType === 'TBA' ? (<g pointerEvents="none" stroke="black" strokeWidth="2" fill="none"><circle cx="0" cy="0" r="18" fill="white"/><polygon points="0,-18 15.58,9 -15.58,9" fill="none" stroke="black" strokeWidth="2"/></g>) : (<rect pointerEvents="none" x="-18" y="-25" width="36" height="50" fill="white" stroke="black" strokeWidth="2"/>)}<text x="25" y="5" fontSize="12" fontWeight="bold" pointerEvents="none">{obj.label}</text>{isSelected && <rect x="-28" y="-28" width="56" height="56" fill="none" stroke={COLORS.highlight} strokeWidth="2" strokeDasharray="3 3" pointerEvents="none"/>}</g>); 
                                if (obj.type === 'icon_ground') {const dx = obj.direction === 'left' ? -20 : 20, dy = -20;return (<g key={obj.id} transform={`translate(${obj.x}, ${obj.y})`} data-id={obj.id} data-type="object"><rect x="-25" y="-25" width="50" height="35" fill="transparent" data-id={obj.id} data-type="object"/><g pointerEvents="none"><line x1={dx} y1={dy} x2="0" y2="0" stroke="black" strokeWidth="2"/><circle cx={dx} cy={dy} r="3" fill="black"/><line x1="-15" y1="0" x2="15" y2="0" stroke="black" strokeWidth="2"/><line x1="-10" y1="4" x2="10" y2="4" stroke="black" strokeWidth="2"/><line x1="-5" y1="8" x2="5" y2="8" stroke="black" strokeWidth="2"/></g>{isSelected && <rect x="-25" y="-25" width="50" height="35" fill="none" stroke={COLORS.highlight} strokeWidth="2" strokeDasharray="3 3" pointerEvents="none"/>}</g>);} 
                                if (obj.type === 'icon_ground_lv') {const isLeft = obj.direction === 'left';const barX = isLeft ? -10 : 10;const barY = 10;const rectX = isLeft ? -20 : 0;const rectY = 0;return (<g key={obj.id} transform={`translate(${obj.x}, ${obj.y})`} data-id={obj.id} data-type="object"><rect x={rectX} y={rectY} width="20" height="20" fill="transparent" data-id={obj.id} data-type="object"/><g pointerEvents="none" stroke="black" strokeWidth="1.5"><circle cx="0" cy="0" r="2" fill="black" stroke="none" /><line x1="0" y1="0" x2={barX} y2={10}/><line x1={barX - 8} y1={10} x2={barX + 8} y2={10}/><line x1={barX - 5} y1={barY + 3} x2={barX + 5} y2={13}/><line x1={barX - 2} y1={barY + 6} x2={barX + 2} y2={16}/></g>{isSelected && <rect x={rectX} y={rectY} width="20" height="20" fill="none" stroke={COLORS.highlight} strokeWidth="1" strokeDasharray="2 2" pointerEvents="none"/>}</g>);} 
                                if (obj.type === 'text') return (<text key={obj.id} x={obj.x} y={obj.y} fontSize={obj.fontSize} fill={isSelected ? COLORS.highlight : "black"} transform={`rotate(${obj.rotate || 0}, ${obj.x}, ${obj.y})`} style={{fontWeight: isSelected ? 'bold' : 'normal'}} data-id={obj.id} data-type="object">{obj.text}</text>); 
                                if (obj.type === 'rect_pvlv') return <g key={obj.id} transform={`translate(${obj.x}, ${obj.y})`} data-id={obj.id} data-type="object"><rect width={obj.width} height={obj.height} fill="rgba(239, 68, 68, 0.05)" stroke={COLORS.pvlv} strokeWidth="2" strokeDasharray="5 5" data-id={obj.id} data-type="object"/><text x="5" y="15" fill={COLORS.pvlv} fontSize="10" fontWeight="bold" pointerEvents="none">PVLV</text>{isSelected && <rect x={obj.width - 20} y={obj.height - 20} width="20" height="20" fill="white" stroke={COLORS.highlight} strokeWidth="2" data-id={obj.id} data-type="object" data-handle="se" />}</g>; 
                                return null; 
                            })}
                        </g>
                    </svg>
                    <div className="absolute top-4 right-4 flex flex-col gap-3">
                        <button onClick={() => fitToScreen(objects)} className="w-10 h-10 bg-white rounded-full shadow-md flex items-center justify-center text-gray-700 active:bg-gray-100" title="V·ªÅ gi·ªØa"><UI_Icons.Target/></button>
                        <button onClick={() => setViewport(prev => ({ ...prev, scale: Math.min(prev.scale * 1.2, 3) }))} className="w-10 h-10 bg-white rounded-full shadow-md flex items-center justify-center text-gray-700 active:bg-gray-100"><UI_Icons.ZoomIn/></button>
                        <button onClick={() => setViewport(prev => ({ ...prev, scale: Math.max(prev.scale / 1.2, 0.5) }))} className="w-10 h-10 bg-white rounded-full shadow-md flex items-center justify-center text-gray-700 active:bg-gray-100"><UI_Icons.ZoomOut/></button>
                    </div>
                </div>
                {selectedId && (<div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-white px-4 py-3 rounded-full shadow-2xl border border-gray-200 flex items-center gap-3 animate-slide-up z-50 overflow-x-auto max-w-[90%] no-scrollbar">{['text', 'icon_device', 'icon_load'].includes(objects.find(o => o.id === selectedId)?.type) && (<button onClick={() => { const obj = objects.find(o => o.id === selectedId); const next = prompt("Nh·∫≠p n·ªôi dung m·ªõi:", obj.type === 'text' ? obj.text : obj.label); if (next !== null) setObjects(prev => prev.map(o => o.id === selectedId ? (o.type === 'text' ? { ...o, text: next } : { ...o, label: next }) : o)); }} className={ACTION_BTN_CLASS + " text-orange-600 border-orange-200"}><UI_Icons.Edit/> S·ª≠a</button>)}{(objects.find(o => o.id === selectedId)?.type === 'text' || objects.find(o => o.id === selectedId)?.type === 'line') && (<button onClick={() => setObjects(prev => prev.map(o => { if (o.id !== selectedId) return o; if (o.type === 'line') { const mx = (o.x1+o.x2)/2, my = (o.y1+o.y2)/2, dx = o.x1-mx, dy = o.y1-my; return { ...o, x1: snapToGrid(mx-dy), y1: snapToGrid(my+dx), x2: snapToGrid(mx+dy), y2: snapToGrid(my-dx) }; } return o.type === 'text' ? { ...o, rotate: o.rotate === 0 ? -90 : 0 } : o; }))} className={ACTION_BTN_CLASS + " text-purple-600 border-purple-200"}><UI_Icons.RotateCcw/> Xoay</button>)}{objects.find(o => o.id === selectedId)?.type === 'line' && (<button onClick={() => setObjects(prev => prev.map(o => o.id === selectedId && o.type === 'line' ? { ...o, dash: !o.dash } : o))} className={ACTION_BTN_CLASS + " text-blue-600 border-blue-200"}><UI_Icons.Minus/> ƒê·ª©t/Li·ªÅn</button>)}<div className="w-[1px] h-6 bg-gray-300 mx-1"></div><button onClick={() => { setObjects(objects.filter(o => o.id !== selectedId)); setSelectedId(null); }} className={ACTION_BTN_CLASS + " text-red-600 border-red-200 bg-red-50"}><UI_Icons.Trash2/> X√≥a</button><button onClick={() => setSelectedId(null)} className="p-2 text-gray-400 hover:text-gray-600"><UI_Icons.X /></button></div>)}
            </div>
        );
    };

    const DiagramPreview = ({ objects }) => {
        if (!objects || objects.length === 0) return null;
        const xs = objects.map(o => o.x || o.cx || o.x1); const ys = objects.map(o => o.y || o.cy || o.y1);
        const minX = Math.min(...xs) - 50; const maxX = Math.max(...xs) + 50; const minY = Math.min(...ys) - 50;
        const maxY = Math.max(...ys) + 50; const width = maxX - minX; const height = maxY - minY;
        return (
            <svg width="100%" height="100%" viewBox={`${minX} ${minY} ${width} ${height}`} preserveAspectRatio="xMidYMid meet">
                 {objects.map(obj => {
                    // S·ª¨A L·ªñI stroke-width TH√ÄNH strokeWidth TRONG PREVIEW LU√îN
                    if (obj.type === 'line') return <line key={obj.id} x1={obj.x1} y1={obj.y1} x2={obj.x2} y2={obj.y2} stroke="black" strokeWidth={obj.strokeWidth} strokeDasharray={obj.dash ? "5,5" : "none"} />;
                    if (obj.type === 'circle') return <circle key={obj.id} cx={obj.cx} cy={obj.cy} r={4} fill="black" />;
                    if (obj.type === 'icon_device') return (<g key={obj.id} transform={`translate(${obj.x}, ${obj.y})`}>{['FCO', 'LBFCO'].includes(obj.subType) ? (<g stroke="black" strokeWidth="2" fill="none"><line x1="-20" y1="-20" x2="20" y2="20"/><path d="M -20 -20 A 18 18 0 0 1 0 0" fill="none" stroke="black" strokeWidth="2"/><path d="M 0 0 A 18 18 0 0 0 20 20" fill={obj.subType === 'LBFCO'?"black":"none"}/></g>) : (<g stroke="black" strokeWidth="2"><rect x="-15" y="-15" width="30" height="30" fill="white"/><line x1="-15" y1="-15" x2="15" y2="15"/><line x1="15" y1="-15" x2="-15" y2="15"/></g>)}<text x="20" y="5" fontSize="12" fontWeight="bold">{obj.label}</text></g>);
                    if (obj.type === 'icon_load') return (<g key={obj.id} transform={`translate(${obj.x}, ${obj.y})`}>{obj.subType === 'TBA' ? (<g stroke="black" strokeWidth="2" fill="none"><circle cx="0" cy="0" r="18" fill="white"/><polygon points="0,-18 15.58,9 -15.58,9" fill="none" stroke="black" strokeWidth="2"/></g>) : (<rect x="-18" y="-25" width="36" height="50" fill="white" stroke="black" strokeWidth="2"/>)}<text x="25" y="5" fontSize="12" fontWeight="bold">{obj.label}</text></g>);
                    if (obj.type === 'icon_ground') {const dx = obj.direction === 'left' ? -20 : 20;return (<g key={obj.id} transform={`translate(${obj.x}, ${obj.y})`}><line x1={dx} y1={-20} x2="0" y2="0" stroke="black" strokeWidth="2"/><circle cx={dx} cy={-20} r="3" fill="black"/><line x1="-15" y1="0" x2="15" y2="0" stroke="black" strokeWidth="2"/><line x1="-10" y1="4" x2="10" y2="4" stroke="black" strokeWidth="2"/><line x1="-5" y1="8" x2="5" y2="8" stroke="black" strokeWidth="2"/></g>);}
                    if (obj.type === 'icon_ground_lv') {const isLeft = obj.direction === 'left';const barX = isLeft ? -10 : 10;const barY = 10;const rectX = isLeft ? -20 : 0;const rectY = 0;return (<g key={obj.id} transform={`translate(${obj.x}, ${obj.y})`} stroke="black" strokeWidth="1.5"><circle cx="0" cy="0" r="2" fill="black" stroke="none"/><line x1="0" y1="0" x2={barX} y2={10}/><line x1={barX-8} y1={10} x2={barX+8} y2={10}/><line x1={barX-5} y1={13} x2={barX+5} y2={13}/><line x1={barX-2} y1={16} x2={barX+2} y2={16}/></g>);}
                    if (obj.type === 'text') return <text key={obj.id} x={obj.x} y={obj.y} fontSize={obj.fontSize} fill="black" transform={`rotate(${obj.rotate||0}, ${obj.x}, ${obj.y})`}>{obj.text}</text>;
                    if (obj.type === 'rect_pvlv') return <g key={obj.id} transform={`translate(${obj.x}, ${obj.y})`}><rect width={obj.width} height={obj.height} fill="rgba(239, 68, 68, 0.05)" stroke={COLORS.pvlv} strokeWidth="2" strokeDasharray="5 5"/><text x="5" y="15" fill={COLORS.pvlv} fontSize="10" fontWeight="bold">PVLV</text></g>;
                    return null;
                })}
            </svg>
        );
    };

    const TimeSelect = ({ value, onChange }) => {
        const [hour, minute] = value ? value.split(':') : ['07', '00'];
        const hours = Array.from({length: 24}, (_, i) => i.toString().padStart(2, '0'));
        const minutes = Array.from({length: 60}, (_, i) => i.toString().padStart(2, '0'));
        const handleChange = (type, val) => {
            let newH = hour, newM = minute;
            if (type === 'h') newH = val;
            if (type === 'm') newM = val;
            onChange(`${newH}:${newM}`);
        };
        return (
            <div className="inline-flex items-center border-b-2 border-gray-300 hover:border-blue-500 bg-transparent gap-0 transition-colors">
                <select value={hour} onChange={(e) => handleChange('h', e.target.value)} className="appearance-none bg-transparent font-bold text-center outline-none cursor-pointer p-1 text-gray-800 hover:bg-gray-100 rounded">
                    {hours.map(h => <option key={h} value={h}>{h}</option>)}
                </select>
                <span className="font-bold px-0.5">:</span>
                <select value={minute} onChange={(e) => handleChange('m', e.target.value)} className="appearance-none bg-transparent font-bold text-center outline-none cursor-pointer p-1 text-gray-800 hover:bg-gray-100 rounded">
                    {minutes.map(m => <option key={m} value={m}>{m}</option>)}
                </select>
            </div>
        );
    };

    const QuickInputSection = ({ title, value, onChange, templates, placeholder, contextData }) => {
        const addTemplate = (template) => {
            let textToAdd = template;
            if (contextData) {
                const fullPoleCode = `${contextData.code}/${contextData.sub}`;
                textToAdd = textToAdd.replace(/{tru}/g, fullPoleCode).replace(/{tuyen}/g, contextData.line || "...");
            }
            const newValue = value ? value + "\n" + textToAdd : textToAdd;
            onChange(newValue);
        };
        return (
            <div className="mb-4">
                <label className="section-title block text-gray-800">{title}</label>
                <div className="flex gap-2 overflow-x-auto no-scrollbar mb-2 pb-1">
                    {templates.map((t, i) => (<button key={i} onClick={() => addTemplate(t.content)} className="tag-btn flex-shrink-0"><UI_Icons.Plus size={12}/> {t.label}</button>))}
                    <button onClick={() => onChange("")} className="tag-btn flex-shrink-0 bg-red-50 text-red-600 border-red-200">X√≥a</button>
                </div>
                <textarea className="w-full border rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" rows="4" value={value} onChange={(e) => onChange(e.target.value)} placeholder={placeholder}></textarea>
            </div>
        );
    };

    // --- MODAL XEM ·∫¢NH (QU·∫¢N L√ù) ---
    const ImageGalleryModal = ({ images, onClose, onZoom }) => {
        if (!images) return null;
        return (
            <div className="fixed inset-0 z-[10000] bg-black/90 flex flex-col" onClick={onClose}>
                <div className="p-4 flex justify-between items-center text-white shrink-0 bg-black/50 backdrop-blur-sm">
                    <h3 className="font-bold text-lg flex items-center gap-2"><UI_Icons.Share2/> H√¨nh ·∫£nh hi·ªán tr∆∞·ªùng ({images.length})</h3>
                    <button onClick={onClose} className="p-2 bg-white/20 rounded-full hover:bg-white/30 transition-colors"><UI_Icons.X/></button>
                </div>
                <div className="flex-1 overflow-y-auto p-4 grid grid-cols-2 md:grid-cols-4 gap-4 content-start">
                    {images.length === 0 ? (
                        <div className="col-span-full text-center text-gray-500 mt-20 flex flex-col items-center">
                            <UI_Icons.Share2 size={48} className="mb-2 opacity-50"/>
                            <span>Kh√¥ng c√≥ h√¨nh ·∫£nh n√†o</span>
                        </div>
                    ) : (
                        images.map((url, i) => (
                            <div key={i} className="relative rounded-lg overflow-hidden border border-gray-700 aspect-square group cursor-pointer" onClick={(e) => { e.stopPropagation(); onZoom(url); }}>
                                <img src={url} className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" alt="Evidence" loading="lazy"/>
                                <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-end justify-end p-2 pointer-events-none">
                                    <div className="text-white text-xs font-bold flex items-center gap-1"><UI_Icons.ZoomIn size={16}/> Xem to</div>
                                </div>
                            </div>
                        ))
                    )}
                </div>
            </div>
        );
    };

    const RiskManagerModal = ({ isOpen, onClose, onRefresh, existingRisks }) => {
        const [mode, setMode] = useState('create');
        const [selectedRiskId, setSelectedRiskId] = useState("");
        const [name, setName] = useState("");
        const [type, setType] = useState("ATLD");
        const [level, setLevel] = useState("II");
        const [desc, setDesc] = useState("");
        const [measure, setMeasure] = useState("");
        const [loading, setLoading] = useState(false);
        useEffect(() => { if (isOpen) { setMode('create'); setSelectedRiskId(""); setName(""); setDesc(""); setMeasure(""); } }, [isOpen]);
        const handleSave = async () => {
            setLoading(true); let targetRiskId = selectedRiskId;
            if (mode === 'create') {
                if (!name.trim()) { alert("Vui l√≤ng nh·∫≠p t√™n m·ªëi nguy!"); setLoading(false); return; }
                const { data, error } = await supabase.from('dm_moi_nguy').insert([{ ten_moi_nguy: name.trim(), bac_rr_mac_dinh: level, loai: type }]).select();
                if (error) { alert("L·ªói l∆∞u: " + error.message); setLoading(false); return; }
                targetRiskId = data[0].id;
            } else { if (!targetRiskId) { alert("Vui l√≤ng ch·ªçn m·ªëi nguy!"); setLoading(false); return; } }
            const descInserts = desc.split('\n').map(l => l.trim()).filter(l => l).map(d => ({ moi_nguy_id: targetRiskId, noi_dung: d }));
            const measureInserts = measure.split('\n').map(l => l.trim()).filter(l => l).map(m => ({ moi_nguy_id: targetRiskId, noi_dung: m }));
            if (descInserts.length > 0) await supabase.from('dm_mo_ta').insert(descInserts);
            if (measureInserts.length > 0) await supabase.from('dm_bien_phap').insert(measureInserts);
            alert("ƒê√£ l∆∞u th√†nh c√¥ng!"); onRefresh(); onClose(); setLoading(false);
        };
        if (!isOpen) return null;
        return (
            <div className="fixed inset-0 bg-black/50 z-[150] flex items-center justify-center p-4" onClick={onClose}>
                <div className="bg-white rounded-lg shadow-xl w-full max-w-lg flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
                    <div className="p-4 border-b bg-blue-600 text-white rounded-t-lg flex justify-between items-center"><h3 className="font-bold text-lg flex items-center gap-2"><UI_Icons.Database /> Qu·∫£n L√Ω Th∆∞ Vi·ªán</h3><button onClick={onClose}><UI_Icons.X size={20}/></button></div>
                    <div className="p-5 overflow-y-auto flex-1 space-y-4">
                        <div className="flex border rounded overflow-hidden mb-4"><button className={`flex-1 py-2 font-bold ${mode === 'create' ? 'bg-blue-100 text-blue-700' : 'bg-white text-gray-500'}`} onClick={() => setMode('create')}>T·∫°o M·ªõi</button><button className={`flex-1 py-2 font-bold ${mode === 'update' ? 'bg-blue-100 text-blue-700' : 'bg-white text-gray-500'}`} onClick={() => setMode('update')}>C·∫≠p Nh·∫≠t</button></div>
                        {mode === 'create' ? (
                            <><div className="mb-2"><label className="block text-sm font-bold text-gray-700 mb-1">T√™n m·ªëi nguy *</label><input className="w-full border rounded p-2" value={name} onChange={e => setName(e.target.value)} /></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-bold text-gray-700 mb-1">Lo·∫°i</label><select className="w-full border rounded p-2" value={type} onChange={e => setType(e.target.value)}><option value="ATLD">ATLD</option><option value="VSLD">VSLD</option></select></div><div><label className="block text-sm font-bold text-gray-700 mb-1">B·∫≠c RR</label><select className="w-full border rounded p-2" value={level} onChange={e => setLevel(e.target.value)}><option value="II">II</option><option value="I">I</option><option value="III">III</option></select></div></div></>
                        ) : (<div><label className="block text-sm font-bold text-gray-700 mb-1">Ch·ªçn m·ªëi nguy *</label><select className="w-full border rounded p-2" value={selectedRiskId} onChange={e => setSelectedRiskId(e.target.value)}><option value="">-- Ch·ªçn --</option>{existingRisks.map(r => (<option key={r.id} value={r.id}>{r.ten_moi_nguy} ({r.loai})</option>))}</select></div>)}
                        <div><label className="block text-sm font-bold text-gray-700 mb-1">Th√™m M√¥ t·∫£ (m·ªói d√≤ng 1 √Ω)</label><textarea className="w-full border rounded p-2" rows="3" value={desc} onChange={e => setDesc(e.target.value)}></textarea></div>
                        <div><label className="block text-sm font-bold text-gray-700 mb-1">Th√™m Bi·ªán ph√°p (m·ªói d√≤ng 1 √Ω)</label><textarea className="w-full border rounded p-2" rows="3" value={measure} onChange={e => setMeasure(e.target.value)}></textarea></div>
                    </div>
                    <div className="p-4 border-t flex justify-end gap-2"><button onClick={onClose} className="px-4 py-2 border rounded">H·ªßy</button><button onClick={handleSave} disabled={loading} className="px-4 py-2 bg-blue-600 text-white rounded font-bold">{loading ? "..." : "L∆∞u"}</button></div>
                </div>
            </div>
        );
    };

    const RiskSelectModal = ({ isOpen, onClose, title, options, selectedValues, onSave }) => {
        const [items, setItems] = useState([]);
        useEffect(() => { if (isOpen) setItems(selectedValues ? selectedValues.split(';').map(x => x.trim()).filter(x => x !== '') : []); }, [isOpen, selectedValues]);
        const toggleOption = (val) => setItems(prev => prev.includes(val) ? prev.filter(i => i !== val) : [...prev, val]);
        const handleSave = () => { onSave(items.join('; ')); onClose(); };
        if (!isOpen) return null;
        return (
            <div className="fixed inset-0 bg-black/50 z-[120] flex items-center justify-center p-4" onClick={onClose}>
                <div className="bg-white rounded-lg shadow-xl w-full max-w-lg flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
                    <div className="p-4 border-b bg-blue-50 flex justify-between items-center"><h3 className="font-bold text-blue-800">{title}</h3><button onClick={onClose}><UI_Icons.X/></button></div>
                    <div className="p-4 overflow-y-auto flex-1 space-y-2">
                        <div className="mb-2"><div className="font-bold text-sm mb-1">ƒê√£ ch·ªçn:</div>{items.map((it, i) => (<div key={i} className="flex gap-2 mb-1"><textarea className="flex-1 border rounded p-1 text-sm" rows="1" value={it} onChange={e => { const n = [...items]; n[i] = e.target.value; setItems(n); }} /><button onClick={() => setItems(items.filter((_, idx) => idx !== i))} className="text-red-500"><UI_Icons.Trash2 size={16}/></button></div>))}</div>
                        <button onClick={() => setItems([...items, ""])} className="text-sm text-blue-600 font-bold flex items-center gap-1"><UI_Icons.Plus size={14}/> Th√™m d√≤ng</button>
                        <hr className="my-2"/>
                        <div className="font-bold text-sm mb-1">G·ª£i √Ω:</div>
                        <div className="space-y-1">{options.map((opt, i) => (<label key={i} className="flex gap-2 p-2 hover:bg-gray-100 rounded cursor-pointer"><input type="checkbox" checked={items.includes(opt.noi_dung)} onChange={() => toggleOption(opt.noi_dung)} /><span className="text-sm">{opt.noi_dung}</span></label>))}</div>
                    </div>
                    <div className="p-3 border-t flex justify-end gap-2"><button onClick={onClose} className="px-4 py-2 border rounded">H·ªßy</button><button onClick={handleSave} className="px-4 py-2 bg-blue-600 text-white rounded font-bold">L∆∞u</button></div>
                </div>
            </div>
        );
    };

// --- COMPONENT TRANG QU·∫¢N L√ù B√ÅO C√ÅO (ƒê√É C·∫¨P NH·∫¨T N√öT ƒêƒÇNG XU·∫§T) ---
    const ReportListPage = ({ isOpen, onCreateNew, onLoad, onExport, onZoom, onLogout, currentUser }) => {
        const [reports, setReports] = useState([]);
        const [loading, setLoading] = useState(false);
        const [filterDate, setFilterDate] = useState(""); 
        const [filterCode, setFilterCode] = useState("");
        const [downloadedIds, setDownloadedIds] = useState([]);
        const [previewImages, setPreviewImages] = useState(null);

        useEffect(() => {
            const updateDownloadedStatus = () => {
                const downloaded = JSON.parse(localStorage.getItem('downloaded_reports') || '[]');
                setDownloadedIds(downloaded);
            };
            if (isOpen) {
                document.body.style.overflow = 'hidden'; 
                fetchReports();
                updateDownloadedStatus();
                window.addEventListener('storage', updateDownloadedStatus);
            } else {
                document.body.style.overflow = '';
            }
            return () => { document.body.style.overflow = ''; window.removeEventListener('storage', updateDownloadedStatus); }
        }, [isOpen]);

        const fetchReports = async (searchCode = filterCode, searchDate = filterDate) => {
            setLoading(true);
            try {
                let query = supabase.from('bien_ban_khao_sat').select('*').order('created_at', { ascending: false });
                if (searchCode && searchCode.trim()) query = query.ilike('ma_tru', `%${searchCode.trim()}%`);
                if (searchDate) {
                    const startDate = new Date(searchDate); startDate.setHours(0, 0, 0, 0);
                    const endDate = new Date(searchDate); endDate.setHours(23, 59, 59, 999);
                    query = query.gte('created_at', startDate.toISOString()).lte('created_at', endDate.toISOString());
                }
                const { data, error } = await query;
                if (error) throw error;
                setReports(data || []);
            } catch (error) { alert("L·ªói t·∫£i danh s√°ch: " + error.message); } finally { setLoading(false); }
        };

        const handleClearFilters = () => { setFilterCode(""); setFilterDate(""); fetchReports("", ""); };
        
        const handleDelete = async (id, e) => {
            e.stopPropagation();
            if(!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a bi√™n b·∫£n n√†y vƒ©nh vi·ªÖn?")) return;
            const { error } = await supabase.from('bien_ban_khao_sat').delete().eq('id', id);
            if (error) alert("L·ªói x√≥a: " + error.message); else fetchReports();
        };

        const handleEditClick = (id) => { onLoad(id); };
        
        const handleExportClick = (report) => { 
            if (onExport) {
                onExport(report);
                if (!downloadedIds.includes(report.id)) {
                    setDownloadedIds([...downloadedIds, report.id]);
                }
            }
        };
        
        const formatDateTime = (isoString) => {
            if (!isoString) return "";
            const date = new Date(isoString);
            const d = date.getDate().toString().padStart(2, '0');
            const m = (date.getMonth() + 1).toString().padStart(2, '0');
            const y = date.getFullYear();
            const h = date.getHours().toString().padStart(2, '0');
            const min = date.getMinutes().toString().padStart(2, '0');
            return `${d}/${m}/${y} - ${h}:${min}`;
        };

        if (!isOpen) return null;

        return (
            <div className="fixed inset-0 bg-gray-100 z-[9999] flex flex-col overflow-hidden" style={{ margin: 0, padding: 0 }}>
                {/* MODAL XEM ·∫¢NH TRONG LIST */}
                <ImageGalleryModal images={previewImages} onClose={() => setPreviewImages(null)} onZoom={onZoom} />

                {/* HEADER (ƒê√É S·ª¨A: TH√äM N√öT ƒêƒÇNG XU·∫§T) */}
                <div className="bg-white border-b px-3 py-2 shadow-sm flex items-center justify-between shrink-0 h-14 relative z-20">
                    <div className="flex items-center gap-2">
                        <h2 className="text-base font-bold text-blue-800 uppercase flex items-center gap-1">
                            <UI_Icons.Database size={18} /> Kho D·ªØ Li·ªáu
                        </h2>
                    </div>
                    
                    <div className="flex items-center gap-2">
                        {/* Hi·ªÉn th·ªã t√™n user tr√™n m√†n h√¨nh l·ªõn */}
                        <span className="text-xs font-bold text-gray-500 hidden sm:block mr-1">Hi, {currentUser}</span>
                        
                        {/* N√öT ƒêƒÇNG XU·∫§T M·ªöI */}
                        <button onClick={onLogout} className="bg-gray-100 hover:bg-red-100 text-red-600 px-3 py-1.5 rounded-full transition-colors border border-gray-200 font-bold text-xs flex items-center gap-1">
                            Tho√°t
                        </button>

                        <button onClick={onCreateNew} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-full transition-colors shadow-md font-bold flex items-center gap-2 text-sm">
                            <UI_Icons.Plus size={18} strokeWidth={3} /> T·∫°o M·ªõi
                        </button>
                    </div>
                </div>

                {/* FILTER BAR */}
                <div className="bg-white p-2 border-b shrink-0 z-10 shadow-sm">
                    <div className="max-w-4xl mx-auto flex gap-2 items-center">
                        <div className="flex-1 relative">
                            <input type="text" className="w-full border border-gray-300 rounded pl-8 pr-2 py-1.5 outline-none focus:border-blue-500 font-bold text-gray-700 text-sm" placeholder="T√¨m s·ªë tr·ª•..." value={filterCode} onChange={(e) => setFilterCode(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && fetchReports()} />
                            <div className="absolute left-2.5 top-2 text-gray-400"><UI_Icons.ZoomIn size={16}/></div>
                        </div>
                        <input type="date" className="border border-gray-300 rounded px-2 py-1.5 outline-none font-medium text-sm w-32" value={filterDate} onChange={(e) => setFilterDate(e.target.value)} />
                        <button onClick={() => fetchReports()} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1.5 px-3 rounded shadow text-sm">T√¨m</button>
                        {(filterDate || filterCode) && (<button onClick={handleClearFilters} className="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-1.5 px-3 rounded" title="H·ªßy l·ªçc"><UI_Icons.RotateCcw size={16}/></button>)}
                    </div>
                </div>

                {/* DANH S√ÅCH */}
                <div className="flex-1 overflow-y-auto bg-gray-100 p-2">
                    <div className="max-w-4xl mx-auto pb-20">
                        {loading ? (
                            <div className="text-center py-8 text-gray-500 text-sm flex flex-col items-center gap-2"><div className="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div> ƒêang t·∫£i...</div>
                        ) : reports.length === 0 ? (
                            <div className="text-center py-10 bg-white rounded border border-gray-200 text-gray-400 italic text-sm">Ch∆∞a c√≥ bi√™n b·∫£n n√†o. B·∫•m "T·∫°o M·ªõi" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</div>
                        ) : (
                            <div className="bg-white rounded border border-gray-200 overflow-hidden shadow-sm">
                                <div className="divide-y divide-gray-100">
                                    {reports.map(r => {
                                        const isDownloaded = downloadedIds.includes(r.id);
                                        const btnClass = isDownloaded ? "bg-green-100 text-green-700 border-green-200 hover:bg-green-200" : "bg-white text-gray-700 border-gray-300 hover:bg-gray-100 hover:text-green-700 hover:border-green-300";
                                        const imgCount = r.du_lieu_form?.hinh_anh ? r.du_lieu_form.hinh_anh.length : 0;
                                        return (
                                            <div key={r.id} className="px-3 py-2.5 hover:bg-blue-50 transition-colors group cursor-default">
                                                <div className="flex items-center justify-between gap-2">
                                                    <div className="flex-1 min-w-0 flex flex-col justify-center">
                                                        <div className="font-bold text-blue-800 text-base leading-tight mb-1 truncate">{r.ma_tru || "---"}</div>
                                                        <div className="flex items-center text-sm text-gray-600 gap-2">
                                                            <span className="truncate max-w-[140px] sm:max-w-[200px]" title={r.ten_tuyen}>{r.ten_tuyen || "(Ch∆∞a c√≥ t√™n tuy·∫øn)"}</span>
                                                            <span className="text-gray-300">|</span>
                                                            <span className="font-medium text-gray-700 whitespace-nowrap">{formatDateTime(r.created_at)}</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-1 shrink-0 self-center">
                                                        {imgCount > 0 ? (
                                                            <button onClick={() => setPreviewImages(r.du_lieu_form.hinh_anh)} className="flex items-center gap-1 px-2 py-1.5 bg-purple-50 text-purple-700 hover:bg-purple-100 border border-purple-200 rounded text-[11px] font-bold active:scale-95 transition-transform shadow-sm" title="Xem ·∫£nh hi·ªán tr∆∞·ªùng"><UI_Icons.Image size={14}/> {imgCount}</button>
                                                        ) : (<button className="p-1.5 text-gray-300 cursor-not-allowed" title="Kh√¥ng c√≥ ·∫£nh"><UI_Icons.Image size={16}/></button>)}
                                                        <button onClick={() => handleEditClick(r.id)} className="flex items-center gap-1 px-2.5 py-1.5 bg-blue-50 text-blue-700 hover:bg-blue-100 border border-blue-200 rounded text-[11px] font-bold active:scale-95 transition-transform shadow-sm"><UI_Icons.Edit size={14}/> S·ª≠a</button>
                                                        <button onClick={() => handleExportClick(r)} className={`flex items-center gap-1 px-2.5 py-1.5 border rounded text-[11px] font-bold active:scale-95 transition-all shadow-sm ${btnClass}`}><UI_Icons.Download size={14}/> Word</button>
                                                        <button onClick={(e) => handleDelete(r.id, e)} className="p-1.5 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded ml-1 transition-colors active:scale-95"><UI_Icons.Trash2 size={18}/></button>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    };

    const App = () => {

// --- CH√àN ƒêO·∫†N N√ÄY V√ÄO ƒê·∫¶U TI√äN TRONG App ---
        const [isAuthenticated, setIsAuthenticated] = useState(false);
        const [isCheckingAuth, setIsCheckingAuth] = useState(false);
        const [currentUser, setCurrentUser] = useState(null);

        // T·ª± ƒë·ªông ƒëƒÉng nh·∫≠p n·∫øu ƒë√£ l∆∞u phi√™n tr∆∞·ªõc ƒë√≥
        useEffect(() => {
            const savedUser = localStorage.getItem('bskht_user');
            if (savedUser) { setIsAuthenticated(true); setCurrentUser(savedUser); }
        }, []);

        // H√†m x·ª≠ l√Ω ƒëƒÉng nh·∫≠p
        const handleLogin = async (username, password) => {
            if(!username || !password) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");
            setIsCheckingAuth(true);
            try {
                const { data, error } = await supabase.from('app_users').select('*').eq('username', username).eq('password', password).single();
                if (error || !data) {
                    alert("Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u!");
                } else {
                    localStorage.setItem('bskht_user', data.full_name || username);
                    setCurrentUser(data.full_name || username);
                    setIsAuthenticated(true);
                }
            } catch (e) { alert("L·ªói k·∫øt n·ªëi: " + e.message); }
            setIsCheckingAuth(false);
        };

        // H√†m ƒëƒÉng xu·∫•t
        const handleLogout = () => {
            if(confirm("ƒêƒÉng xu·∫•t kh·ªèi t√†i kho·∫£n?")) {
                localStorage.removeItem('bskht_user');
                setIsAuthenticated(false);
                setCurrentUser(null);
            }
        };


        // --- 1. C√ÅC H√ÄM TI·ªÜN √çCH (DATE HELPER) ---
        // L·∫•y ng√†y h√¥m nay chu·∫©n ISO (yyyy-mm-dd) cho input type="date"
        const getTodayISO = () => {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        };

        // Chuy·ªÉn ƒë·ªïi ng√†y t·ª´ ISO (yyyy-mm-dd) sang VN (dd/mm/yyyy) ƒë·ªÉ xu·∫•t Word
        const formatDateVN = (isoDate) => {
            if (!isoDate) return ".../.../...";
            const [y, m, d] = isoDate.split('-');
            return `${d}/${m}/${y}`;
        };

        // --- 2. C·∫§U TR√öC D·ªÆ LI·ªÜU M·∫∂C ƒê·ªäNH (Quan tr·ªçng ƒë·ªÉ s·ª≠a l·ªói s·ª≠a 1 b·ªã h·∫øt) ---
        const DEFAULT_FORM_DATA = {
            donVi: "ƒê·ªòI QU·∫¢N L√ù ƒêI·ªÜN CH√ÇU PH√ö", 
            ngay: new Date().getDate(), thang: new Date().getMonth() + 1, nam: new Date().getFullYear(), gioKhaoSat: "07:30",
            loc_poleCode: "", loc_subCode: "", loc_lineName: "", loc_commune: "", 
            dvct_daiDien1: "", dvct_chucVu1: "", dvct_daiDien2: "", dvct_chucVu2: "",
            qlvh_daiDien1: "", qlvh_chucVu1: "", qlvh_donVi1: "", qlvh_daiDien2: "", qlvh_chucVu2: "", qlvh_donVi2: "",
            qlvh_daiDien3: "", qlvh_chucVu3: "", qlvh_donVi3: "",
            dv_lienQuan: "", muc4_diaDiem: "", muc5_noiDung: "", muc6_phamVi: "",
            muc7_thoiGianTu: "08:00", muc7_thoiGianDen: "17:00", 
            muc7_ngay: getTodayISO(),       // M·∫∑c ƒë·ªãnh ng√†y hi·ªán t·∫°i
            phieu_dgrr_ngay: getTodayISO(), // M·∫∑c ƒë·ªãnh ng√†y hi·ªán t·∫°i
            ruiRo_ATLD: [{ riskId: 1, moiNguy: "Ph√≥ng ƒëi·ªán", moTa: "ƒêi·ªán h·∫° √°p gi·∫≠t", bac: "II", bienPhap: "Th·ª±c hi·ªán bi·ªán ph√°p an to√†n..." }],
            ruiRo_VSLD: [{ riskId: null, moiNguy: "", moTa: "", bac: "", bienPhap: "" }],
            ruiRo_ghiChu: "- Th·ª±c hi·ªán bi·ªán ph√°p an to√†n theo ƒë√∫ng tr√¨nh t·ª± trong ph∆∞∆°ng √°n thi c√¥ng ƒë√£ ƒë∆∞·ª£c duy·ªát.\n- S·ª≠ d·ª•ng t·∫•m l√≥t ch√®n ch√¢n ch·ªëng ƒë·∫£m b·∫£o c·ª©ng c√°p.\n- ƒê·∫∑t r√†o ch·∫Øn xung quanh v·ªã tr√≠ c√¥ng t√°c.\n- Tu√¢n th·ªß ƒë·∫ßy ƒë·ªß bi·ªán ph√°p an to√†n khi l√†m vi·ªác tr√™n cao.\n- Tr√°nh l√†m vi·ªác khi th·ªùi ti·∫øt qu√° n√≥ng.",
            muc9a_catDien: "", muc9b_anToan: "- Chu·∫©n b·ªã ƒë·∫ßy ƒë·ªß trang thi·∫øt b·ªã...", muc9c_dieuDo: "", muc9d_khac: "", soBan: "01",
            hinh_anh: [] // M·∫£ng ch·ª©a URL ·∫£nh
        };

        const [dbPoles, setDbPoles] = useState([]);
        const [dbCommunes, setDbCommunes] = useState([{name: "Th·∫°nh M·ªπ T√¢y"}, {name: "M·ªπ ƒê·ª©c"}]);
        const [dbStaff, setDbStaff] = useState(["Cao Th√†nh T√¢n", "Nguy·ªÖn VƒÉn T√¢m"]);
        const [dbPositions, setDbPositions] = useState(["Ch·ªâ huy tr·ª±c ti·∫øp", "Gi√°m s√°t an to√†n", "T·ªï tr∆∞·ªüng", "K·ªπ thu·∫≠t vi√™n", "C√¥ng nh√¢n", "ƒê·ªôi tr∆∞·ªüng", "ƒê·ªôi ph√≥"]);
        const [dbUnits, setDbUnits] = useState(["ƒê·ªôi Qu·∫£n l√Ω ƒëi·ªán Ch√¢u Ph√∫", "Ph√≤ng K·ªπ thu·∫≠t an to√†n"]);
        const [showDiagram, setShowDiagram] = useState(false);
        const [diagramData, setDiagramData] = useState([]);
        const [riskLibrary, setRiskLibrary] = useState({ risks: [], descriptions: [], measures: [] });
        const [modalConfig, setModalConfig] = useState({ isOpen: false, rowIndex: null, type: null, listType: null, options: [] });
        const [showReportList, setShowReportList] = useState(true);
        const [showRiskManager, setShowRiskManager] = useState(false);
        const [currentReportId, setCurrentReportId] = useState(null);
        
        // Kh·ªüi t·∫°o form v·ªõi d·ªØ li·ªáu m·∫∑c ƒë·ªãnh copy
        const [formData, setFormData] = useState({ ...DEFAULT_FORM_DATA });
        // State Zoom ·∫¢nh
        const [zoomImage, setZoomImage] = useState(null);

        const fetchRiskLibrary = async () => {
            const { data: risks } = await supabase.from('dm_moi_nguy').select('*');
            const { data: descs } = await supabase.from('dm_mo_ta').select('*');
            const { data: measures } = await supabase.from('dm_bien_phap').select('*');
            if (risks && risks.length > 0) { setRiskLibrary({ risks, descriptions: descs || [], measures: measures || [] }); }
        };

        useEffect(() => {
            const fetchData = async () => {
                const { data: poles } = await supabase.from('poles').select('code, line_name'); if (poles) setDbPoles(poles); else setDbPoles([{code: "478CD", line_name: "478 C√°i D·∫ßu"}]); 
                const { data: communes } = await supabase.from('communes').select('name'); if (communes) setDbCommunes(communes); 
                const { data: staffData } = await supabase.from('staff').select('name, position, unit');
                if (staffData && staffData.length > 0) {
                    setDbStaff(staffData.map(s => s.name));
                    setDbPositions([...new Set(staffData.map(s => s.position).filter(p => p))]);
                    setDbUnits([...new Set(staffData.map(s => s.unit).filter(u => u))]);
                }
                await fetchRiskLibrary();
            };
            fetchData();
        }, []);

        const handlePoleChange = (e) => { const selectedCode = e.target.value; const found = dbPoles.find(p => p.code === selectedCode); setFormData(prev => ({ ...prev, loc_poleCode: selectedCode, loc_lineName: found ? found.line_name : "" })); };
        const tags9a = [ { label: "C·∫Øt CB", content: "- C·∫Øt CB tr·ª• {tru} tuy·∫øn {tuyen}" }, { label: "C·∫Øt 3 FCO", content: "- C·∫Øt 03FCO tr·ª• {tru} tuy·∫øn {tuyen}" }, { label: "C·∫Øt 2 FCO", content: "- C·∫Øt 02FCO tr·ª• {tru} tuy·∫øn {tuyen}" }, { label: "Ti·∫øp ƒë·ªãa HA", content: "- Th·ª≠ ƒëi·ªán, ti·∫øp ƒë·ªãa h·∫° √°p 01 b·ªô t·∫°i tr·ª• {tru} tuy·∫øn {tuyen}" }, { label: "Th√°o l√®o", content: "- Th√°o 03 n·ªëi r·∫Ω tr·ª• {tru} tuy·∫øn {tuyen}" }, { label: "Kh√≥a t·ªß", content: "- Kh√≥a t·ªß CB tr·ª• {tru} tuy·∫øn {tuyen}" } ];
        const tags9b = [ { label: "M·∫´u chu·∫©n", content: "- Chu·∫©n b·ªã ƒë·∫ßy ƒë·ªß trang thi·∫øt b·ªã, d·ª•ng c·ª• thi c√¥ng.\n- Trang b·ªã ƒë·∫ßy ƒë·ªß BHLƒê.\n- Kh√¥ng v∆∞·ª£t kh·ªèi ph·∫°m vi l√†m vi·ªác.\n- Tr·∫£ ƒëi·ªán ƒë√∫ng gi·ªù." }, { label: "Th√™m d√¢y an to√†n", content: "- S·ª≠ d·ª•ng d√¢y an to√†n 2 m√≥c khi leo cao." }, { label: "Th√™m r√†o ch·∫Øn", content: "- ƒê·∫∑t r√†o ch·∫Øn, bi·ªÉn b√°o an to√†n." } ];
        // Danh s√°ch n·ªôi dung c√¥ng vi·ªác m·∫´u
        const taskTemplates = [
            "Thay ƒëi·ªán k·∫ø ƒë·ªãnh k·ª≥",
            "Thay ƒëi·ªán k·∫ø ch√°y h·ªèng",
            "Di d·ªùi ƒëi·ªán k·∫ø v·ªÅ tr·ª•",
            "Ki·ªÉm tra, x·ª≠ l√Ω ti·∫øp x√∫c l√®o",
            "S·ª≠a ch·ªØa ƒëi·ªán c√°p h·∫° √°p",
            "V·ªá sinh, b·∫£o d∆∞·ª°ng tr·∫°m bi·∫øn √°p",
            "Ph√°t quang c√¢y xanh trong h√†nh lang tuy·∫øn"
        ];
        // State ph·ª• ƒë·ªÉ gi·ªØ gi√° tr·ªã ƒëang ch·ªçn trong dropdown m·∫´u
        const [selectedTaskTemplate, setSelectedTaskTemplate] = useState("");

        // --- DANH S√ÅCH M·∫™U CHO M·ª§C 6 ---
        const scopeTemplates = [
            "T·∫°i ƒë·∫ßu tr·ª•",
            "T·∫°i t·ªß ƒëi·ªán k·∫ø",
            "T·∫°i ƒë√† tr·∫°m bi·∫øn √°p",
            "To√†n b·ªô tr·∫°m bi·∫øn √°p",
            "D·ªçc theo h√†nh lang tuy·∫øn",
            "T·∫°i v·ªã tr√≠ c√¥ng t√°c"
        ];
        const [selectedScopeTemplate, setSelectedScopeTemplate] = useState("");

        const getContextData = () => { return { code: formData.loc_poleCode, sub: formData.loc_subCode, line: formData.loc_lineName }; };
        
        const generateDiagramImage = async (data) => {
            if (!data || data.length === 0) return null;
            return new Promise((resolve) => {
                let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
                data.forEach(obj => { if (obj.type === 'line') { minX = Math.min(minX, obj.x1, obj.x2); maxX = Math.max(maxX, obj.x1, obj.x2); minY = Math.min(minY, obj.y1, obj.y2); maxY = Math.max(maxY, obj.y1, obj.y2); } else if (obj.type === 'rect_pvlv') { minX = Math.min(minX, obj.x); maxX = Math.max(maxX, obj.x + obj.width); minY = Math.min(minY, obj.y); maxY = Math.max(maxY, obj.y + obj.height); } else { const cx = obj.x !== undefined ? obj.x : obj.cx; const cy = obj.y !== undefined ? obj.y : obj.cy; const size = 40; minX = Math.min(minX, cx - size); maxX = Math.max(maxX, cx + size); minY = Math.min(minY, cy - size); maxY = Math.max(maxY, cy + size); } });
                const padding = 50; minX -= padding; maxX += padding; minY -= padding; maxY += padding;
                const width = maxX - minX; const height = maxY - minY;
                let svgContent = `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="${minX} ${minY} ${width} ${height}" style="background-color: white;">`;
                data.forEach(obj => {
                    if(obj.type === 'line') svgContent += `<line x1="${obj.x1}" y1="${obj.y1}" x2="${obj.x2}" y2="${obj.y2}" stroke="black" stroke-width="${obj.strokeWidth}" stroke-dasharray="${obj.dash?'5,5':'none'}" />`;
                    if(obj.type === 'circle') svgContent += `<circle cx="${obj.cx}" cy="${obj.cy}" r="4" fill="black" />`;
                    if(obj.type === 'text') svgContent += `<text x="${obj.x}" y="${obj.y}" font-family="Arial" font-size="${obj.fontSize}" transform="rotate(${obj.rotate||0}, ${obj.x}, ${obj.y})">${obj.text}</text>`;
                    if(obj.type === 'icon_device') { svgContent += `<g transform="translate(${obj.x}, ${obj.y})">`; if(['FCO', 'LBFCO'].includes(obj.subType)) svgContent += `<line x1="-20" y1="-20" x2="20" y2="20" stroke="black" stroke-width="2"/><path d="M -20 -20 A 18 18 0 0 1 0 0" fill="none" stroke="black" stroke-width="2"/><path d="M 0 0 A 18 18 0 0 0 20 20" fill="${obj.subType==='LBFCO'?'black':'none'}" stroke="black" stroke-width="2"/>`; else svgContent += `<rect x="-15" y="-15" width="30" height="30" fill="white" stroke="black" stroke-width="2"/><line x1="-15" y1="-15" x2="15" y2="15" stroke="black" stroke-width="2"/><line x1="15" y1="-15" x2="-15" y2="15" stroke="black" stroke-width="2"/>`; svgContent += `<text x="20" y="5" font-family="Arial" font-size="12" font-weight="bold">${obj.label}</text></g>`; }
                    if(obj.type === 'icon_load') { svgContent += `<g transform="translate(${obj.x}, ${obj.y})">`; if(obj.subType === 'TBA') svgContent += `<circle cx="0" cy="0" r="18" fill="white" stroke="black" stroke-width="2"/><polygon points="0,-18 15.58,9 -15.58,9" fill="none" stroke="black" stroke-width="2"/>`; else svgContent += `<rect x="-18" y="-25" width="36" height="50" fill="white" stroke="black" stroke-width="2"/>`; svgContent += `<text x="25" y="5" font-family="Arial" font-size="12" font-weight="bold">${obj.label}</text></g>`; }
                    if(obj.type === 'icon_ground') { const dx = obj.direction === 'left' ? -20 : 20; svgContent += `<g transform="translate(${obj.x}, ${obj.y})"><line x1="${dx}" y1="-20" x2="0" y2="0" stroke="black" stroke-width="2"/><circle cx="${dx}" cy="-20" r="3" fill="black"/><line x1="-15" y1="0" x2="15" y2="0" stroke="black" stroke-width="2"/><line x1="-10" y1="4" x2="10" y2="4" stroke="black" stroke-width="2"/><line x1="-5" y1="8" x2="5" y2="8" stroke="black" stroke-width="2"/></g>`; }
                    if(obj.type === 'icon_ground_lv') { const barX = obj.direction === 'left' ? -10 : 10; svgContent += `<g transform="translate(${obj.x}, ${obj.y})"><circle cx="0" cy="0" r="2" fill="black"/><line x1="0" y1="0" x2="${barX}" y2="10" stroke="black" stroke-width="1.5"/><line x1="${barX-8}" y1="10" x2="${barX+8}" y2="10" stroke="black" stroke-width="1.5"/><line x1="${barX-5}" y1="13" x2="${barX+5}" y2="13" stroke="black" stroke-width="1.5"/><line x1="${barX-2}" y1="16" x2="${barX+2}" y2="16" stroke="black" stroke-width="1.5"/></g>`; }
                    if(obj.type === 'rect_pvlv') { svgContent += `<g transform="translate(${obj.x}, ${obj.y})"><rect width="${obj.width}" height="${obj.height}" fill="none" stroke="#ef4444" stroke-width="2" stroke-dasharray="5,5"/><text x="5" y="15" fill="#ef4444" font-size="10" font-weight="bold">PVLV</text></g>`; }
                });
                svgContent += `</svg>`;
                const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); const img = new Image();
                img.onload = () => { ctx.drawImage(img, 0, 0); resolve({ dataUrl: canvas.toDataURL("image/png"), width: width, height: height }); };
                img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgContent)));
            });
        };

        // --- H√ÄM XU·∫§T WORD (FINAL: T·ªåA ƒê·ªò ƒê∆Ø·ªúNG K·∫∫ S√ÅT + SPACING NG√ÄY 12PT) ---
        const handleExportDocx = async (targetReport = null) => {

            // ƒê·∫∑t ƒëo·∫°n n√†y ·ªü ƒë·∫ßu h√†m handleExportDocx
            const txtDots = (val, dots = 30) => (val && val.trim() !== "") ? val : ".".repeat(dots);
          
            const sourceForm = targetReport ? targetReport.du_lieu_form : formData;
            const sourceDiagram = targetReport ? targetReport.du_lieu_so_do : diagramData;
            
            // 1. C·∫§U H√åNH T√äN FILE
            const d = String(sourceForm.ngay).padStart(2, '0');
            const m = String(sourceForm.thang).padStart(2, '0');
            const y = sourceForm.nam;
            const cleanTuyen = (sourceForm.loc_lineName || "").replace(/[\\/:*?"<>|]/g, "_");
            let rawTru = sourceForm.loc_poleCode || "Moi";
            if (sourceForm.loc_subCode) rawTru += "/" + sourceForm.loc_subCode;
            const cleanTru = rawTru.replace(/\//g, ".").replace(/[\\:*?"<>|]/g, "_");
            const filename = `${d}-${m}-${y}-${cleanTuyen}-${cleanTru}.docx`;

            // 2. L∆ØU TR·∫†NG TH√ÅI
            if (targetReport && targetReport.id) {
                const downloaded = JSON.parse(localStorage.getItem('downloaded_reports') || '[]');
                if (!downloaded.includes(targetReport.id)) {
                    downloaded.push(targetReport.id);
                    localStorage.setItem('downloaded_reports', JSON.stringify(downloaded));
                    window.dispatchEvent(new Event('storage'));
                }
            }

            // --- HELPER: T·∫†O ·∫¢NH ƒê∆Ø·ªúNG K·∫∫ ---
            const createLineBuffer = async (widthPx) => {
                const canvas = document.createElement('canvas');
                canvas.width = widthPx;
                canvas.height = 2; // ƒê·ªô d√†y n√©t
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = "black";
                ctx.fillRect(0, 0, widthPx, 2);
                
                const dataUrl = canvas.toDataURL("image/png");
                const res = await fetch(dataUrl);
                const blob = await res.blob();
                return await blob.arrayBuffer();
            };

            const lineShort = await createLineBuffer(80); 
            const lineLong = await createLineBuffer(210);

            // 3. T·∫†O FILE WORD
            const { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, AlignmentType, BorderStyle, HorizontalPositionRelativeFrom, VerticalPositionRelativeFrom, TextWrappingType, TextWrappingSide } = window.docx;
            let diagramImage = null, imgWidth = 600, imgHeight = 400;
            
            if (sourceDiagram && sourceDiagram.length > 0) {
                try {
                    const { dataUrl, width, height } = await generateDiagramImage(sourceDiagram);
                    const res = await fetch(dataUrl); const blob = await res.blob(); const buffer = await blob.arrayBuffer();
                    diagramImage = buffer; const MAX_WIDTH = 600; imgWidth = Math.min(width, MAX_WIDTH); imgHeight = (height / width) * imgWidth;
                } catch (e) {}
            }
            
            // H√†m t·∫°o ƒëo·∫°n vƒÉn b·∫£n
            const createPara = (text, isBold = false, fontSize = 24, align = AlignmentType.LEFT, isItalic = false) => {
                return new Paragraph({
                    children: [ new TextRun({ text: text, bold: isBold, size: fontSize, font: "Times New Roman", italics: isItalic }) ],
                    alignment: align,
                    spacing: { after: 50, before: 50 }
                });
            };

            const formatMultilineText = (text) => { 
                if (!text) return [createPara("")]; 
                return text.split('\n').map(line => createPara(line.trim())); 
            };

            // Format ng√†y th√°ng hi·ªÉn th·ªã Word
            const dateMuc7 = formatDateVN(sourceForm.muc7_ngay);
            const datePhieu = formatDateVN(sourceForm.phieu_dgrr_ngay);

            const doc = new Document({
                sections: [{
                    properties: {},
                    children: [
                        // --- HEADER TABLE ---
                        new Table({ 
                            width: { size: 100, type: WidthType.PERCENTAGE }, 
                            borders: { top: {style: BorderStyle.NONE}, bottom: {style: BorderStyle.NONE}, left: {style: BorderStyle.NONE}, right: {style: BorderStyle.NONE}, insideVertical: {style: BorderStyle.NONE}, insideHorizontal: {style: BorderStyle.NONE} }, 
                            rows: [new TableRow({ children: [ 
                                // C·ªòT TR√ÅI
                                new TableCell({ children: [
                                    createPara("C√îNG TY ƒêI·ªÜN L·ª∞C AN GIANG", false, 24, AlignmentType.CENTER),
                                    
                                    // ƒê∆†N V·ªä + LINE NG·∫ÆN (ƒê√£ ch·ªânh offset l√™n 180000)
                                    new Paragraph({
                                        children: [
                                            new TextRun({ text: sourceForm.donVi.toUpperCase(), bold: true, size: 24, font: "Times New Roman" }),
                                            new window.docx.ImageRun({
                                                data: lineShort,
                                                transformation: { width: 80, height: 1 },
                                                floating: {
                                                    horizontalPosition: { relative: HorizontalPositionRelativeFrom.COLUMN, align: AlignmentType.CENTER },
                                                    verticalPosition: { 
                                                        relative: VerticalPositionRelativeFrom.PARAGRAPH, 
                                                        offset: 180000 // T·ªåA ƒê·ªò M·ªöI
                                                    },
                                                    wrap: { type: TextWrappingType.NONE, side: TextWrappingSide.BOTH }
                                                }
                                            })
                                        ],
                                        alignment: AlignmentType.CENTER,
                                        spacing: { before: 50, after: 100 }
                                    })
                                ] }), 
                                // C·ªòT PH·∫¢I
                                new TableCell({ children: [
                                    createPara("C·ªòNG H√íA X√É H·ªòI CH·ª¶ NGHƒ®A VI·ªÜT NAM", true, 24, AlignmentType.CENTER),
                                    
                                    // ƒê·ªòC L·∫¨P... + LINE D√ÄI (ƒê√£ ch·ªânh offset l√™n 200000)
                                    new Paragraph({
                                        children: [
                                            new TextRun({ text: "ƒê·ªôc l·∫≠p - T·ª± do - H·∫°nh ph√∫c", bold: true, size: 26, font: "Times New Roman" }),
                                            new window.docx.ImageRun({
                                                data: lineLong,
                                                transformation: { width: 210, height: 1 },
                                                floating: {
                                                    horizontalPosition: { relative: HorizontalPositionRelativeFrom.COLUMN, align: AlignmentType.CENTER },
                                                    verticalPosition: { 
                                                        relative: VerticalPositionRelativeFrom.PARAGRAPH, 
                                                        offset: 200000 // T·ªåA ƒê·ªò M·ªöI
                                                    },
                                                    wrap: { type: TextWrappingType.NONE, side: TextWrappingSide.BOTH }
                                                }
                                            })
                                        ],
                                        alignment: AlignmentType.CENTER,
                                        spacing: { before: 50, after: 50 }
                                    }),
                                    
                                    // NG√ÄY TH√ÅNG (ƒê√£ ch·ªânh spacing before = 240 ~ 12pt)
                                    new Paragraph({
                                        children: [new TextRun({ text: `Ch√¢u Ph√∫, ng√†y ${sourceForm.ngay} th√°ng ${sourceForm.thang} nƒÉm ${sourceForm.nam}`, italics: true, size: 24, font: "Times New Roman" })],
                                        alignment: AlignmentType.CENTER,
                                        spacing: { before: 240, after: 50 } 
                                    })
                                ] }), 
                            ]})], 
                        }),
                        
                        // --- N·ªòI DUNG CH√çNH (Gi·ªØ nguy√™n) ---
                        createPara("", false, 24), 
                        createPara("BI√äN B·∫¢N KH·∫¢O S√ÅT HI·ªÜN TR∆Ø·ªúNG", true, 28, AlignmentType.CENTER),
                        createPara("", false, 24),
                        
                        createPara(`V√†o h·ªìi ${sourceForm.gioKhaoSat}, t·∫°i tr·ª• ${sourceForm.loc_poleCode}/${sourceForm.loc_subCode} tuy·∫øn ${sourceForm.loc_lineName}, x√£ ${sourceForm.loc_commune}, t·ªânh An Giang.`, false, 24, AlignmentType.JUSTIFIED),
                        


createPara("Ch√∫ng t√¥i g·ªìm:", true, 24),
                        
                        // --- M·ª§C 1: ƒê∆†N V·ªä C√îNG T√ÅC ---
                        createPara("1. ƒê·∫°i di·ªán ƒê∆°n v·ªã c√¥ng t√°c:", true, 24),
                        new Table({
                            width: { size: 100, type: WidthType.PERCENTAGE },
                            borders: { top: {style: BorderStyle.NONE}, bottom: {style: BorderStyle.NONE}, left: {style: BorderStyle.NONE}, right: {style: BorderStyle.NONE}, insideVertical: {style: BorderStyle.NONE}, insideHorizontal: {style: BorderStyle.NONE} },
                            rows: [
                                new TableRow({ children: [
                                    new TableCell({ children: [createPara(`1.1. √îng (B√†): ${txtDots(sourceForm.dvct_daiDien1, 35)}`, false, 24)], width: { size: 60, type: WidthType.PERCENTAGE } }),
                                    new TableCell({ children: [createPara(`Ch·ª©c v·ª•: ${txtDots(sourceForm.dvct_chucVu1, 20)}`, false, 24)], width: { size: 40, type: WidthType.PERCENTAGE } })
                                ]}),
                                new TableRow({ children: [
                                    new TableCell({ children: [createPara(`1.2. √îng (B√†): ${txtDots(sourceForm.dvct_daiDien2, 35)}`, false, 24)], width: { size: 60, type: WidthType.PERCENTAGE } }),
                                    new TableCell({ children: [createPara(`Ch·ª©c v·ª•: ${txtDots(sourceForm.dvct_chucVu2, 20)}`, false, 24)], width: { size: 40, type: WidthType.PERCENTAGE } })
                                ]})
                            ]
                        }),

                        // --- M·ª§C 2: ƒê∆†N V·ªä QLVH (ƒê√£ gi·∫£m s·ªë l∆∞·ª£ng d·∫•u ch·∫•m ƒë·ªÉ kh√¥ng tr√†n h√†ng) ---
                        createPara("2. ƒê·∫°i di·ªán (c√°c) ƒê∆°n v·ªã QLVH:", true, 24),
                        new Table({
                            width: { size: 100, type: WidthType.PERCENTAGE },
                            borders: { top: {style: BorderStyle.NONE}, bottom: {style: BorderStyle.NONE}, left: {style: BorderStyle.NONE}, right: {style: BorderStyle.NONE}, insideVertical: {style: BorderStyle.NONE}, insideHorizontal: {style: BorderStyle.NONE} },
                            rows: [
                                new TableRow({ children: [
                                    new TableCell({ children: [createPara(`2.1. √îng (B√†): ${txtDots(sourceForm.qlvh_daiDien1, 25)}`, false, 24)], width: { size: 45, type: WidthType.PERCENTAGE } }),
                                    new TableCell({ children: [createPara(`Ch·ª©c v·ª•: ${txtDots(sourceForm.qlvh_chucVu1, 15)}`, false, 24)], width: { size: 25, type: WidthType.PERCENTAGE } }),
                                    new TableCell({ children: [createPara(`ƒê∆°n v·ªã: ${txtDots(sourceForm.qlvh_donVi1, 15)}`, false, 24)], width: { size: 30, type: WidthType.PERCENTAGE } })
                                ]}),
                                new TableRow({ children: [
                                    new TableCell({ children: [createPara(`2.2. √îng (B√†): ${txtDots(sourceForm.qlvh_daiDien2, 25)}`, false, 24)], width: { size: 45, type: WidthType.PERCENTAGE } }),
                                    new TableCell({ children: [createPara(`Ch·ª©c v·ª•: ${txtDots(sourceForm.qlvh_chucVu2, 15)}`, false, 24)], width: { size: 25, type: WidthType.PERCENTAGE } }),
                                    new TableCell({ children: [createPara(`ƒê∆°n v·ªã: ${txtDots(sourceForm.qlvh_donVi2, 15)}`, false, 24)], width: { size: 30, type: WidthType.PERCENTAGE } })
                                ]}),
                                new TableRow({ children: [
                                    new TableCell({ children: [createPara(`2.3. √îng (B√†): ${txtDots(sourceForm.qlvh_daiDien3, 25)}`, false, 24)], width: { size: 45, type: WidthType.PERCENTAGE } }),
                                    new TableCell({ children: [createPara(`Ch·ª©c v·ª•: ${txtDots(sourceForm.qlvh_chucVu3, 15)}`, false, 24)], width: { size: 25, type: WidthType.PERCENTAGE } }),
                                    new TableCell({ children: [createPara(`ƒê∆°n v·ªã: ${txtDots(sourceForm.qlvh_donVi3, 15)}`, false, 24)], width: { size: 30, type: WidthType.PERCENTAGE } })
                                ]})
                            ]
                        }),

                        // --- M·ª§C 3: S·ª¨A L·ªñI IN ƒê·∫¨M D·∫§U CH·∫§M ---
                        new Paragraph({
                            children: [
                                new TextRun({ text: "3. ƒê·∫°i di·ªán c√°c ƒë∆°n v·ªã c√≥ li√™n quan: ", bold: true, size: 24, font: "Times New Roman" }),
                                new TextRun({ text: txtDots(sourceForm.dv_lienQuan, 50), bold: false, size: 24, font: "Times New Roman" })
                            ],
                            spacing: { after: 50, before: 50 }
                        }),
                        
                        new Paragraph({ 
                            children: [
                                new TextRun({ 
                                    text: "C√πng nhau kh·∫£o s√°t th·ª±c t·∫ø, trao ƒë·ªïi v√† th·ªëng nh·∫•t ph√¢n c√¥ng tr√°ch nhi·ªám th·ª±c hi·ªán nh·ªØng n·ªôi dung ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n v·ªÅ ƒëi·ªán cho ƒê∆°n v·ªã c√¥ng t√°c khi ti·∫øn h√†nh c√¥ng vi·ªác, c·ª• th·ªÉ nh∆∞ sau:", 
                                    size: 24, 
                                    font: "Times New Roman",
                                    italics: false // T·∫Øt nghi√™ng cho ch·ªØ
                                })
                            ], 
                            alignment: AlignmentType.JUSTIFIED, 
                            spacing: { after: 100 },
                            style: "Normal" // √âp v·ªÅ ki·ªÉu m·∫∑c ƒë·ªãnh ƒë·ªÉ kh√¥ng b·ªã d√≠nh ƒë·ªãnh d·∫°ng c≈©
                        }),
                        
                        // M·ª•c 4
                        new Paragraph({
                            children: [
                                new TextRun({ text: "4. ƒê·ªãa ƒëi·ªÉm (ho·∫∑c thi·∫øt b·ªã) th·ª±c hi·ªán c√¥ng vi·ªác: ", bold: true, size: 24, font: "Times New Roman" }),
                                new TextRun({ text: sourceForm.muc4_diaDiem + ".", bold: false, size: 24, font: "Times New Roman" })
                            ],
                            spacing: { after: 50, before: 50 }
                        }),

                        // M·ª•c 5
                        new Paragraph({
                            children: [
                                new TextRun({ text: "5. N·ªôi dung c√¥ng vi·ªác: ", bold: true, size: 24, font: "Times New Roman" }),
                                new TextRun({ text: sourceForm.muc5_noiDung + ".", bold: false, size: 24, font: "Times New Roman" })
                            ],
                            spacing: { after: 50, before: 50 }
                        }),

                        // M·ª•c 6
                        new Paragraph({
                            children: [
                                new TextRun({ text: "6. Ph·∫°m vi l√†m vi·ªác: ", bold: true, size: 24, font: "Times New Roman" }),
                                new TextRun({ text: sourceForm.muc6_phamVi + ".", bold: false, size: 24, font: "Times New Roman" })
                            ],
                            spacing: { after: 50, before: 50 }
                        }),

                        // M·ª•c 7
                        new Paragraph({
                            children: [
                                new TextRun({ text: "7. Th·ªùi gian ti·∫øn h√†nh c√¥ng vi·ªác: ", bold: true, size: 24, font: "Times New Roman" }),
                                new TextRun({ 
                                    text: `T·ª´ ${sourceForm.muc7_thoiGianTu} ƒë·∫øn ${sourceForm.muc7_thoiGianDen}, ng√†y ${dateMuc7}.`, 
                                    bold: false, size: 24, font: "Times New Roman" 
                                })
                            ],
                            spacing: { after: 50, before: 50 }
                        }),

                        createPara("8. K·∫øt qu·∫£ ƒê√°nh gi√° r·ªßi ro c·ªßa ƒë∆°n v·ªã c√¥ng t√°c:", true, 24),
                        // D√íNG PHI·∫æU ƒêGRR M·ªöI TH√äM
                        createPara(`a) K·∫øt qu·∫£ ƒêGRR t·∫°i hi·ªán tr∆∞·ªùng (Theo Phi·∫øu ƒêGRR ng√†y ${datePhieu})`, false, 24),

                        new Table({ 
                            width: { size: 100, type: WidthType.PERCENTAGE }, 
                            rows: [ 
                                new TableRow({ children: ["Stt", "Nh·∫≠n di·ªán m·ªëi nguy", "M√¥ t·∫£ m·ªëi nguy", "B·∫≠c RR", "Bi·ªán ph√°p ki·ªÉm so√°t"].map(text => new TableCell({ children: [createPara(text, true, 24, AlignmentType.CENTER)], shading: { fill: "f3f4f6" } })) }), 
                                
                                // D√≤ng ATLƒê: CƒÉn gi·ªØa, B·ªè t√¥ m√†u
                                new TableRow({ children: [new TableCell({ children: [createPara("ATLƒê", true, 24, AlignmentType.CENTER)], columnSpan: 5 })] }), 
                                
                                ...sourceForm.ruiRo_ATLD.map((item, idx) => new TableRow({ children: [
                                    new TableCell({ children: [createPara((idx + 1).toString(), false, 24, AlignmentType.CENTER)] }), 
                                    new TableCell({ children: [createPara(item.moiNguy)] }), 
                                    new TableCell({ children: [createPara(item.moTa)] }), 
                                    new TableCell({ children: [createPara(item.bac, false, 24, AlignmentType.CENTER)] }), 
                                    new TableCell({ children: [createPara(item.bienPhap)] })
                                ] })), 
                                
                                // D√≤ng VSLƒê: CƒÉn gi·ªØa, B·ªè t√¥ m√†u
                                new TableRow({ children: [new TableCell({ children: [createPara("VSLƒê", true, 24, AlignmentType.CENTER)], columnSpan: 5 })] }), 
                                
                                ...sourceForm.ruiRo_VSLD.map((item, idx) => new TableRow({ children: [
                                    new TableCell({ children: [createPara((idx + 1).toString(), false, 24, AlignmentType.CENTER)] }), 
                                    new TableCell({ children: [createPara(item.moiNguy)] }), 
                                    new TableCell({ children: [createPara(item.moTa)] }), 
                                    new TableCell({ children: [createPara(item.bac, false, 24, AlignmentType.CENTER)] }), 
                                    new TableCell({ children: [createPara(item.bienPhap)] })
                                ] })), 
                            ] 
                        }),
                        
                        createPara("b) Ghi ch√∫:", true, 24), ...formatMultilineText(sourceForm.ruiRo_ghiChu), createPara("", false, 24),
                        
                        createPara("9. Tr√°ch nhi·ªám c·ªßa c√°c ƒë∆°n v·ªã li√™n quan:", true, 24),
                        createPara("a/ ƒê·ªëi v·ªõi (c√°c) ƒë∆°n v·ªã qu·∫£n l√Ω v·∫≠n h√†nh:", true, 24), ...formatMultilineText(sourceForm.muc9a_catDien),
                        createPara("b/ ƒê·ªëi v·ªõi ƒë∆°n v·ªã c√¥ng t√°c:", true, 24), ...formatMultilineText(sourceForm.muc9b_anToan),
                        createPara("c/ ƒê·ªëi v·ªõi (c√°c) ƒë∆°n v·ªã ƒëi·ªÅu ƒë·ªô (n·∫øu c√≥):", true, 24), ...formatMultilineText(sourceForm.muc9c_dieuDo),
                        createPara("d/ Nh·ªØng n·ªôi dung kh√°c li√™n quan ƒë·∫øn c√¥ng vi·ªác:", true, 24), ...formatMultilineText(sourceForm.muc9d_khac),

                        
                        createPara(`Bi√™n b·∫£n n√†y ƒë∆∞·ª£c l·∫≠p th√†nh ${sourceForm.soBan} b·∫£n v√† ƒë∆∞·ª£c t·∫•t c·∫£ m·ªçi ng∆∞·ªùi d·ª± h·ªçp l√† ƒë·∫°i di·ªán c·ªßa c√°c ƒë∆°n v·ªã c√≥ li√™n quan ƒë·∫øn c√¥ng vi·ªác ƒë·ªìng √Ω, th√¥ng qua ƒë·ªÉ l√†m c∆° s·ªü ti·∫øn h√†nh c√¥ng vi·ªác sau n√†y (n·∫øu kh√¥ng thay ƒë·ªïi v·ªÅ nh·ªØng n·ªôi dung ch√≠nh) v√† k√Ω t√™n d∆∞·ªõi ƒë√¢y.`, false, 24, AlignmentType.JUSTIFIED),
                        createPara("", false, 24),
                        
// --- PH·∫¶N CH·ªÆ K√ù (ƒê√É S·ª¨A: 3 C·ªòT TR√äN + 1 C·ªòT D∆Ø·ªöI) ---
                        
                        // H√ÄNG 1: ƒê∆°n v·ªã c√¥ng t√°c | ƒê∆°n v·ªã QLVH | ƒê∆°n v·ªã ƒêi·ªÅu ƒë·ªô
                        new Table({ 
                            width: { size: 100, type: WidthType.PERCENTAGE }, 
                            borders: { top: {style: BorderStyle.NONE}, bottom: {style: BorderStyle.NONE}, left: {style: BorderStyle.NONE}, right: {style: BorderStyle.NONE}, insideVertical: {style: BorderStyle.NONE}, insideHorizontal: {style: BorderStyle.NONE} }, 
                            rows: [ 
                                // D√≤ng ti√™u ƒë·ªÅ
                                new TableRow({ children: [ 
                                    new TableCell({ children: [createPara("ƒê∆†N V·ªä C√îNG T√ÅC", true, 24, AlignmentType.CENTER)] }), 
                                    new TableCell({ children: [createPara("ƒê∆†N V·ªä QLVH", true, 24, AlignmentType.CENTER)] }),
                                    new TableCell({ children: [createPara("ƒê∆†N V·ªä ƒêI·ªÄU ƒê·ªò", true, 24, AlignmentType.CENTER)] }) 
                                ] }), 
                                // D√≤ng k√Ω t√™n
                                new TableRow({ children: [ 
                                    // C·ªôt ƒê∆°n v·ªã c√¥ng t√°c
                                    new TableCell({ children: [ 
                                        createPara("(K√Ω, ghi r√µ h·ªç t√™n)", false, 24, AlignmentType.CENTER, true), 
                                        createPara("", false, 24), createPara("", false, 24), createPara("", false, 24), 
                                        createPara(sourceForm.dvct_daiDien1, true, 24, AlignmentType.CENTER) 
                                    ] }), 
                                    // C·ªôt ƒê∆°n v·ªã QLVH
                                    new TableCell({ children: [ 
                                        createPara("(K√Ω, ghi r√µ h·ªç t√™n)", false, 24, AlignmentType.CENTER, true), 
                                        createPara("", false, 24), createPara("", false, 24), createPara("", false, 24), 
                                        createPara(sourceForm.qlvh_daiDien1, true, 24, AlignmentType.CENTER) 
                                    ] }),
                                    // C·ªôt ƒê∆°n v·ªã ƒêi·ªÅu ƒë·ªô (Lu√¥n hi·ªán d√π kh√¥ng c√≥ d·ªØ li·ªáu)
                                    new TableCell({ children: [ 
                                        createPara("(K√Ω, ghi r√µ h·ªç t√™n)", false, 24, AlignmentType.CENTER, true), 
                                        createPara("", false, 24), createPara("", false, 24), createPara("", false, 24), 
                                        createPara("", true, 24, AlignmentType.CENTER) 
                                    ] }) 
                                ] }) 
                            ] 
                        }),

                        // Kho·∫£ng c√°ch gi·ªØa 2 h√†ng ch·ªØ k√Ω
                        createPara("", false, 24),

                        // H√ÄNG 2: C√°c ƒë∆°n v·ªã li√™n quan (CƒÉn gi·ªØa ph√≠a d∆∞·ªõi)
                        new Table({ 
                            width: { size: 100, type: WidthType.PERCENTAGE }, 
                            borders: { top: {style: BorderStyle.NONE}, bottom: {style: BorderStyle.NONE}, left: {style: BorderStyle.NONE}, right: {style: BorderStyle.NONE}, insideVertical: {style: BorderStyle.NONE}, insideHorizontal: {style: BorderStyle.NONE} }, 
                            rows: [ 
                                new TableRow({ children: [ 
                                    new TableCell({ children: [
                                        createPara("C√ÅC ƒê∆†N V·ªä LI√äN QUAN KH√ÅC", true, 24, AlignmentType.CENTER),
                                        createPara("", false, 24),
                                        createPara("", true, 24, AlignmentType.CENTER)
                                    ] })
                                ] }) 
                            ] 
                        }),
                        
                        createPara("", false, 24), createPara("", false, 24),
                        createPara("S∆† ƒê·ªí M·ªòT S·ª¢I K·∫æT N·ªêI THI·∫æT B·ªä, L∆Ø·ªöI ƒêI·ªÜN N∆†I L√ÄM VI·ªÜC", true, 24, AlignmentType.CENTER),
                        createPara("(K√®m theo Bi√™n b·∫£n kh·∫£o s√°t hi·ªán tr∆∞·ªùng)", false, 24, AlignmentType.CENTER, true),
                        diagramImage ? new Paragraph({ children: [ new window.docx.ImageRun({ data: diagramImage, transformation: { width: imgWidth, height: imgHeight } }) ], alignment: AlignmentType.CENTER }) : createPara("(Ch∆∞a c√≥ s∆° ƒë·ªì)", false, 24, AlignmentType.CENTER, true)
                    ]
                }]
            });
            Packer.toBlob(doc).then(blob => { saveAs(blob, filename); });
        };

        const handleSaveCloud = async () => {
            if (!confirm("B·∫°n c√≥ ƒë·ªìng √Ω l∆∞u bi√™n b·∫£n n√†y v√† tho√°t ra m√†n h√¨nh ch√≠nh kh√¥ng?")) return;
            if (!formData.loc_poleCode) { alert("Vui l√≤ng nh·∫≠p M√£ tr·ª• tr∆∞·ªõc khi l∆∞u!"); return; }
            const payload = { ma_tru: formData.loc_poleCode + (formData.loc_subCode ? '/' + formData.loc_subCode : ''), ten_tuyen: formData.loc_lineName, du_lieu_form: formData, du_lieu_so_do: diagramData, updated_at: new Date().toISOString() };
            let error;
            if (currentReportId) { const res = await supabase.from('bien_ban_khao_sat').update(payload).eq('id', currentReportId); error = res.error; } 
            else { const res = await supabase.from('bien_ban_khao_sat').insert([payload]).select(); error = res.error; }
            if (error) alert("L·ªói khi l∆∞u: " + error.message);
            else { alert("ƒê√£ l∆∞u th√†nh c√¥ng!"); setShowReportList(true); }
        };

        const handleLoadReport = async (id) => {
            const { data, error } = await supabase.from('bien_ban_khao_sat').select('*').eq('id', id).single();
            if (error) { alert("L·ªói t·∫£i bi√™n b·∫£n: " + error.message); } 
            else if (data) { 
                const savedForm = data.du_lieu_form || {};
                setFormData({ 
                    ...DEFAULT_FORM_DATA, 
                    ...savedForm,
                    phieu_dgrr_ngay: savedForm.phieu_dgrr_ngay || getTodayISO(),
                    muc7_ngay: savedForm.muc7_ngay || getTodayISO()
                }); 
                setDiagramData(data.du_lieu_so_do || []); 
                setCurrentReportId(data.id); 
                setShowReportList(false); 
            }
        };

        const handleCreateNew = () => {
            // Reset s·∫°ch s·∫Ω v·ªÅ m·∫∑c ƒë·ªãnh
            setFormData({ ...DEFAULT_FORM_DATA, phieu_dgrr_ngay: getTodayISO(), muc7_ngay: getTodayISO() });
            setDiagramData([]); setCurrentReportId(null); setShowReportList(false);
        };

        // --- X·ª¨ L√ù ·∫¢NH (Upload l√™n Supabase) ---
        const handleImageUpload = async (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            // KI·ªÇM TRA BUCKET TR∆Ø·ªöC KHI UPLOAD
            // L∆∞u √Ω: Ng∆∞·ªùi d√πng ph·∫£i t·∫°o bucket 'survey_images' public trong Supabase Dashboard
            const bucketName = 'survey_images';
            
            // Upload t·ª´ng ·∫£nh
            const uploadPromises = files.map(async (file) => {
                const fileExt = file.name.split('.').pop();
                const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;
                const filePath = `${fileName}`;

                try {
                    const { data, error } = await supabase.storage.from(bucketName).upload(filePath, file);
                    
                    if (error) {
                        console.error("Upload l·ªói:", error);
                        if (error.message.includes("Bucket not found")) {
                            alert("Ch∆∞a t·∫°o Bucket! H√£y v√†o Supabase > Storage > T·∫°o bucket t√™n 'survey_images' v√† set Public.");
                        } else if (error.message.includes("policy")) {
                            alert("L·ªói quy·ªÅn truy c·∫≠p! H√£y v√†o Supabase > Storage > Policies > T·∫°o policy cho ph√©p INSERT public.");
                        }
                        return null;
                    }

                    // L·∫•y URL public
                    const { data: publicUrlData } = supabase.storage.from(bucketName).getPublicUrl(filePath);
                    return publicUrlData.publicUrl;
                } catch (err) {
                    console.error("L·ªói h·ªá th·ªëng upload:", err);
                    return null;
                }
            });

            // Ch·ªù t·∫•t c·∫£ ·∫£nh upload xong
            const uploadedUrls = (await Promise.all(uploadPromises)).filter(url => url !== null);
            
            // C·∫≠p nh·∫≠t state
            setFormData(prev => ({
                ...prev,
                hinh_anh: [...(prev.hinh_anh || []), ...uploadedUrls]
            }));
        };

// --- H√ÄM X√ìA ·∫¢NH (ƒê√É S·ª¨A: X√ìA C·∫¢ TR√äN CLOUD) ---
        const removeImage = async (index) => {
            const urlToDelete = formData.hinh_anh[index];
            
            // 1. X√°c nh·∫≠n tr∆∞·ªõc khi x√≥a (tr√°nh b·∫•m nh·∫ßm)
            if(!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a ·∫£nh n√†y?")) return;

            // 2. X√≥a kh·ªèi giao di·ªán ngay l·∫≠p t·ª©c
            const newImages = [...(formData.hinh_anh || [])];
            newImages.splice(index, 1);
            setFormData({ ...formData, hinh_anh: newImages });

            // 3. X√≥a file tr√™n Supabase Storage (Ch·∫°y ng·∫ßm)
            if (urlToDelete) {
                try {
                    // URL th∆∞·ªùng c√≥ d·∫°ng: .../public/survey_images/filename.jpg
                    // Ta c·∫ßn l·∫•y ph·∫ßn: filename.jpg
                    const bucketName = 'survey_images';
                    const parts = urlToDelete.split(`${bucketName}/`);
                    
                    if (parts.length > 1) {
                        const filePath = parts.pop(); // L·∫•y ph·∫ßn cu·ªëi c√πng
                        await supabase.storage.from(bucketName).remove([filePath]);
                        console.log("ƒê√£ x√≥a file tr√™n cloud:", filePath);
                    }
                } catch (err) {
                    console.error("L·ªói x√≥a file cloud:", err);
                }
            }
        };

        const handleRiskTypeChange = (listKey, index, e) => {
            const riskId = parseInt(e.target.value); const riskObj = riskLibrary.risks.find(r => r.id === riskId); const newRisks = [...formData[listKey]];
            newRisks[index] = { ...newRisks[index], riskId: riskId, moiNguy: riskObj ? riskObj.ten_moi_nguy : "", bac: riskObj ? riskObj.bac_rr_mac_dinh : "", moTa: "", bienPhap: "" };
            setFormData({ ...formData, [listKey]: newRisks });
        };
        const openRiskModal = (listKey, index, field) => { const currentRow = formData[listKey][index]; const riskId = currentRow.riskId; if (!riskId) { alert("Vui l√≤ng ch·ªçn 'Nh·∫≠n di·ªán m·ªëi nguy' tr∆∞·ªõc."); return; } let options = field === 'moTa' ? riskLibrary.descriptions.filter(d => d.moi_nguy_id === riskId) : riskLibrary.measures.filter(m => m.moi_nguy_id === riskId); setModalConfig({ isOpen: true, rowIndex: index, type: field, listType: listKey, options: options, title: field === 'moTa' ? `M√¥ t·∫£: ${currentRow.moiNguy}` : `Bi·ªán ph√°p: ${currentRow.moiNguy}`, currentValue: currentRow[field] }); };
        const saveModalSelection = (value) => { const { listType, rowIndex, type } = modalConfig; const newRisks = [...formData[listType]]; newRisks[rowIndex][type] = value; setFormData({ ...formData, [listType]: newRisks }); };
        const updateRiskRowManual = (listKey, index, field, value) => { const newRisks = [...formData[listKey]]; newRisks[index][field] = value; setFormData({ ...formData, [listKey]: newRisks }); };
        const addRiskRow = (type) => { const listKey = type === 'ATLD' ? 'ruiRo_ATLD' : 'ruiRo_VSLD'; setFormData({ ...formData, [listKey]: [...formData[listKey], { riskId: "", moiNguy: "", moTa: "", bac: "", bienPhap: "" }] }); };
        const removeRiskRow = (type, index) => { const listKey = type === 'ATLD' ? 'ruiRo_ATLD' : 'ruiRo_VSLD'; const newRisks = formData[listKey].filter((_, i) => i !== index); setFormData({...formData, [listKey]: newRisks}); };

// N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p th√¨ hi·ªán m√†n h√¨nh Login
        if (!isAuthenticated) return <LoginScreen onLogin={handleLogin} loading={isCheckingAuth} />;

        return (
            <div className="pb-20">
                {/* --- MODAL PH√ìNG TO ·∫¢NH (M·ªöI - TO√ÄN M√ÄN H√åNH ƒêEN) --- */}
                {zoomImage && (
                    <div className="fixed inset-0 z-[99999] bg-black flex flex-col items-center justify-center animate-zoom-in" onClick={() => setZoomImage(null)}>
                        {/* Toolbar tr√™n c√πng */}
                        <div className="absolute top-0 left-0 right-0 p-4 flex justify-between items-center bg-gradient-to-b from-black/80 to-transparent z-[99999] text-white">
                            <span className="text-sm font-medium opacity-70">Ch·∫°m v√†o n·ªÅn ƒë·ªÉ ƒë√≥ng</span>
                            <div className="flex gap-4">
                                <a href={zoomImage} target="_blank" className="flex items-center gap-1 font-bold text-blue-300 hover:text-white border border-blue-300 rounded px-3 py-1.5 text-xs bg-black/50 backdrop-blur-md" onClick={(e) => e.stopPropagation()}>
                                    <UI_Icons.Share2 size={16}/> M·ªü ·∫¢nh G·ªëc (Zoom n√©t)
                                </a>
                                <button onClick={() => setZoomImage(null)} className="bg-white/20 rounded-full p-2 hover:bg-red-500 transition-colors backdrop-blur-md"><UI_Icons.X size={24}/></button>
                            </div>
                        </div>
                        
                        {/* ·∫¢nh hi·ªÉn th·ªã full kh√¥ng padding, gi·ªØ nguy√™n t·ªâ l·ªá */}
                        <div className="w-full h-full flex items-center justify-center p-0 m-0 overflow-hidden">
                            <img 
                                src={zoomImage} 
                                className="max-w-full max-h-full object-contain" 
                                alt="Zoom View" 
                                onClick={(e) => e.stopPropagation()} // B·∫•m v√†o ·∫£nh ko b·ªã ƒë√≥ng
                            />
                        </div>
                    </div>
                )}

                {showDiagram && <DiagramEditor initialData={diagramData} onSave={(data) => setDiagramData(data)} onClose={() => setShowDiagram(false)} />}
                <RiskSelectModal isOpen={modalConfig.isOpen} onClose={() => setModalConfig({...modalConfig, isOpen: false})} title={modalConfig.title} options={modalConfig.options} selectedValues={modalConfig.currentValue} onSave={saveModalSelection} />
                {/* ƒê√£ th√™m onLogout v√† currentUser v√†o ƒë√¢y */}
                <ReportListPage 
                    isOpen={showReportList} 
                    onCreateNew={handleCreateNew} 
                    onLoad={handleLoadReport} 
                    onExport={handleExportDocx} 
                    onZoom={(url) => setZoomImage(url)} 
                    onLogout={handleLogout}      // <--- M·ªõi
                    currentUser={currentUser}    // <--- M·ªõi
                />
                <RiskManagerModal isOpen={showRiskManager} onClose={() => setShowRiskManager(false)} onRefresh={fetchRiskLibrary} existingRisks={riskLibrary.risks} />

                <div className="fixed bottom-0 left-0 right-0 bg-white border-t p-3 flex justify-between items-center z-40 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                    <div className="text-xs text-gray-500 font-medium">{currentReportId ? <span className="text-blue-600 font-bold">ƒêang s·ª≠a: {formData.loc_poleCode}</span> : "ƒêang t·∫°o m·ªõi"}</div>
                    <div className="flex gap-2">
                        <button 
                            onClick={async () => { 
                                if(confirm("D·ªØ li·ªáu ch∆∞a l∆∞u s·∫Ω m·∫•t. B·∫°n ch·∫Øc ch·∫Øn mu·ªën tho√°t?")) {
                                    // N·∫æU ƒêANG T·∫†O M·ªöI (Ch∆∞a c√≥ ID) -> X√≥a s·∫°ch ·∫£nh v·ª´a up ƒë·ªÉ tr√°nh r√°c
                                    if (!currentReportId && formData.hinh_anh.length > 0) {
                                        const bucketName = 'survey_images';
                                        const pathsToDelete = formData.hinh_anh.map(url => url.split(`${bucketName}/`).pop());
                                        await supabase.storage.from(bucketName).remove(pathsToDelete);
                                        console.log("ƒê√£ d·ªçn d·∫πp ·∫£nh r√°c do h·ªßy t·∫°o m·ªõi");
                                    }
                                    setShowReportList(true); 
                                }
                            }} 
                            className="bg-gray-100 text-gray-600 px-3 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-gray-200 border border-gray-300 text-xs md:text-sm"
                        >
                            H·ªßy/Tho√°t
                        </button>
                        <button onClick={() => setShowRiskManager(true)} className="bg-orange-100 text-orange-700 px-3 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-orange-200 border border-orange-300" title="Qu·∫£n l√Ω M·ªëi Nguy"><UI_Icons.Plus size={18}/> <span className="hidden md:inline">M·ªëi Nguy</span></button>
                        <button onClick={handleSaveCloud} className="bg-green-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-green-700 active:scale-95 transition-all shadow-md"><UI_Icons.Save size={18}/> L∆∞u & Tho√°t</button>
                        <button onClick={() => handleExportDocx(null)} className="bg-blue-600 text-white px-3 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-blue-700 shadow-md"><UI_Icons.Download size={18}/></button>
                    </div>
                </div>

                <div className="a4-paper">
                    <div className="flex justify-between mb-6 text-center text-sm"><div className="w-1/2"><div className="font-bold uppercase">C√îNG TY ƒêI·ªÜN L·ª∞C AN GIANG</div><input className="input-line text-center uppercase font-bold" value={formData.donVi} onChange={e => setFormData({...formData, donVi: e.target.value})} /><hr className="w-1/3 mx-auto mt-1 border-gray-400" /></div><div className="w-1/2"><div className="font-bold uppercase">C·ªòNG H√íA X√É H·ªòI CH·ª¶ NGHƒ®A VI·ªÜT NAM</div><div className="font-bold underline decoration-1 underline-offset-4">ƒê·ªôc l·∫≠p - T·ª± do - H·∫°nh ph√∫c</div><div className="mt-2 italic">Ch√¢u Ph√∫, ng√†y <input type="number" className="w-8 text-center border-b border-gray-300 outline-none" value={formData.ngay} onChange={e => setFormData({...formData, ngay: e.target.value})} /> th√°ng <input type="number" className="w-8 text-center border-b border-gray-300 outline-none" value={formData.thang} onChange={e => setFormData({...formData, thang: e.target.value})} /> nƒÉm <input type="number" className="w-12 text-center border-b border-gray-300 outline-none" value={formData.nam} onChange={e => setFormData({...formData, nam: e.target.value})} /></div></div></div>
                    <h1 className="text-xl font-bold text-center mb-4 uppercase">BI√äN B·∫¢N KH·∫¢O S√ÅT HI·ªÜN TR∆Ø·ªúNG</h1>
                    <div className="mb-4 text-justify flex flex-wrap items-end gap-1 text-[15px] leading-7"><span>V√†o h·ªìi</span><div className="mx-1"><TimeSelect value={formData.gioKhaoSat} onChange={(val) => setFormData({...formData, gioKhaoSat: val})} /></div><span>t·∫°i tr·ª•</span><input list="pole-list" className="border-b border-gray-300 font-bold bg-transparent outline-none w-[100px] text-center" value={formData.loc_poleCode} onChange={handlePoleChange} placeholder="Ch·ªçn/Nh·∫≠p m√£..." /><span>/</span><input className="border-b border-gray-300 outline-none font-bold w-45 text-center" value={formData.loc_subCode} onChange={e => setFormData({...formData, loc_subCode: e.target.value})} placeholder="..." /><span>tuy·∫øn</span><input list="line-list" className="font-bold border-b border-gray-300 w-[180px] px-1 text-center text-blue-800 bg-transparent outline-none" value={formData.loc_lineName} onChange={e => setFormData({...formData, loc_lineName: e.target.value})} placeholder="..." /><span>, x√£</span><select className="border-b border-gray-300 font-bold bg-transparent outline-none min-w-[80px]" value={formData.loc_commune} onChange={e => setFormData({...formData, loc_commune: e.target.value})}><option value="">Ch·ªçn x√£</option>{dbCommunes.map(c => <option key={c.name} value={c.name}>{c.name}</option>)}</select><span>, t·ªânh An Giang.</span></div>
                    <div className="mb-2 font-bold">Ch√∫ng t√¥i g·ªìm:</div>
                    <datalist id="pole-list">{dbPoles.map(p => <option key={p.code} value={p.code} />)}</datalist><datalist id="line-list">{[...new Set(dbPoles.map(p => p.line_name))].map((l, i) => <option key={i} value={l} />)}</datalist><datalist id="staff-list">{dbStaff.map((name, i) => <option key={i} value={name} />)}</datalist><datalist id="position-list">{dbPositions.map((pos, i) => <option key={i} value={pos} />)}</datalist><datalist id="unit-list">{dbUnits.map((u, i) => <option key={i} value={u} />)}</datalist>
                    <div className="mb-4 pl-4"><div className="font-bold">1. ƒê·∫°i di·ªán ƒê∆°n v·ªã c√¥ng t√°c:</div><div className="grid grid-cols-1 md:grid-cols-2 gap-4 pl-4 mt-2"><div className="flex flex-col gap-1 border p-2 rounded bg-gray-50 border-dashed border-gray-300"><div className="flex gap-2 items-center"><span className="font-semibold text-sm">1.1 √îng (B√†):</span><input list="staff-list" className="input-line flex-grow font-bold text-blue-800" value={formData.dvct_daiDien1} onChange={e => setFormData({...formData, dvct_daiDien1: e.target.value})} placeholder="Nh·∫≠p/Ch·ªçn t√™n..." /></div><div className="flex gap-2 items-center"><span className="text-sm">Ch·ª©c v·ª•:</span><input list="position-list" className="input-line flex-grow bg-transparent" value={formData.dvct_chucVu1} onChange={e => setFormData({...formData, dvct_chucVu1: e.target.value})} placeholder="Ch·ªçn..." /></div></div><div className="flex flex-col gap-1 border p-2 rounded bg-gray-50 border-dashed border-gray-300"><div className="flex gap-2 items-center"><span className="font-semibold text-sm">1.2 √îng (B√†):</span><input list="staff-list" className="input-line flex-grow font-bold text-blue-800" value={formData.dvct_daiDien2} onChange={e => setFormData({...formData, dvct_daiDien2: e.target.value})} placeholder="Nh·∫≠p/Ch·ªçn t√™n..." /></div><div className="flex gap-2 items-center"><span className="text-sm">Ch·ª©c v·ª•:</span><input list="position-list" className="input-line flex-grow bg-transparent" value={formData.dvct_chucVu2} onChange={e => setFormData({...formData, dvct_chucVu2: e.target.value})} placeholder="Ch·ªçn..." /></div></div></div></div>
{/* --- M·ª§C 2: ƒê·∫†I DI·ªÜN QLVH (C·∫§U TR√öC GRID C≈® - TH√äM 2.3) --- */}
                    <div className="mb-4 pl-4">
                        <div className="font-bold">2. ƒê·∫°i di·ªán (c√°c) ƒê∆°n v·ªã QLVH:</div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 pl-4 mt-2">
                            
                            {/* √î 2.1 */}
                            <div className="flex flex-col gap-1 border p-2 rounded bg-gray-50 border-dashed border-gray-300">
                                <div className="flex gap-2 items-center"><span className="font-semibold text-sm">2.1 √îng (B√†):</span><input list="staff-list" className="input-line flex-grow font-bold text-blue-800" value={formData.qlvh_daiDien1} onChange={e => setFormData({...formData, qlvh_daiDien1: e.target.value})} placeholder="Nh·∫≠p t√™n..." /></div>
                                <div className="flex gap-2"><div className="flex items-center w-1/2 gap-1"><span className="text-sm">Ch·ª©c v·ª•:</span><input list="position-list" className="input-line bg-transparent" value={formData.qlvh_chucVu1} onChange={e => setFormData({...formData, qlvh_chucVu1: e.target.value})} /></div><div className="flex items-center w-1/2 gap-1"><span className="text-sm">ƒê∆°n v·ªã:</span><input list="unit-list" className="input-line bg-transparent" value={formData.qlvh_donVi1} onChange={e => setFormData({...formData, qlvh_donVi1: e.target.value})} /></div></div>
                            </div>

                            {/* √î 2.2 */}
                            <div className="flex flex-col gap-1 border p-2 rounded bg-gray-50 border-dashed border-gray-300">
                                <div className="flex gap-2 items-center"><span className="font-semibold text-sm">2.2 √îng (B√†):</span><input list="staff-list" className="input-line flex-grow font-bold text-blue-800" value={formData.qlvh_daiDien2} onChange={e => setFormData({...formData, qlvh_daiDien2: e.target.value})} placeholder="Nh·∫≠p t√™n..." /></div>
                                <div className="flex gap-2"><div className="flex items-center w-1/2 gap-1"><span className="text-sm">Ch·ª©c v·ª•:</span><input list="position-list" className="input-line bg-transparent" value={formData.qlvh_chucVu2} onChange={e => setFormData({...formData, qlvh_chucVu2: e.target.value})} /></div><div className="flex items-center w-1/2 gap-1"><span className="text-sm">ƒê∆°n v·ªã:</span><input list="unit-list" className="input-line bg-transparent" value={formData.qlvh_donVi2} onChange={e => setFormData({...formData, qlvh_donVi2: e.target.value})} /></div></div>
                            </div>

                            {/* √î 2.3 (M·ªöI TH√äM V√ÄO GRID) */}
                            <div className="flex flex-col gap-1 border p-2 rounded bg-gray-50 border-dashed border-gray-300">
                                <div className="flex gap-2 items-center"><span className="font-semibold text-sm">2.3 √îng (B√†):</span><input list="staff-list" className="input-line flex-grow font-bold text-blue-800" value={formData.qlvh_daiDien3} onChange={e => setFormData({...formData, qlvh_daiDien3: e.target.value})} placeholder="Nh·∫≠p t√™n (n·∫øu c√≥)..." /></div>
                                <div className="flex gap-2"><div className="flex items-center w-1/2 gap-1"><span className="text-sm">Ch·ª©c v·ª•:</span><input list="position-list" className="input-line bg-transparent" value={formData.qlvh_chucVu3} onChange={e => setFormData({...formData, qlvh_chucVu3: e.target.value})} /></div><div className="flex items-center w-1/2 gap-1"><span className="text-sm">ƒê∆°n v·ªã:</span><input list="unit-list" className="input-line bg-transparent" value={formData.qlvh_donVi3} onChange={e => setFormData({...formData, qlvh_donVi3: e.target.value})} /></div></div>
                            </div>

                        </div>
                    </div>

                    <div className="mb-4 pl-4"><div className="font-bold">3. ƒê·∫°i di·ªán c√°c ƒë∆°n v·ªã c√≥ li√™n quan:</div><textarea className="input-line pl-4 resize-none" rows="2" value={formData.dv_lienQuan} onChange={e => setFormData({...formData, dv_lienQuan: e.target.value})} placeholder="..."></textarea></div>

                    <div className="mb-4 text-justify text-black font-normal">C√πng nhau kh·∫£o s√°t th·ª±c t·∫ø, trao ƒë·ªïi v√† th·ªëng nh·∫•t ph√¢n c√¥ng tr√°ch nhi·ªám th·ª±c hi·ªán nh·ªØng n·ªôi dung ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n v·ªÅ ƒëi·ªán cho ƒê∆°n v·ªã c√¥ng t√°c khi ti·∫øn h√†nh c√¥ng vi·ªác, c·ª• th·ªÉ nh∆∞ sau:</div>

                    <div className="space-y-3 mb-6">{/* --- M·ª§C 4: ƒê·ªäA ƒêI·ªÇM (ƒê√É S·ª¨A: GI·ªÆ NGUY√äN C·∫§U TR√öC G·ªêC, TH√äM N√öT D√ÅN) --- */}
                        <div>
                            <div className="flex flex-wrap items-center gap-2 mb-1">
                                <span className="font-bold">4. ƒê·ªãa ƒëi·ªÉm (ho·∫∑c thi·∫øt b·ªã) th·ª±c hi·ªán c√¥ng vi·ªác:</span>
                                
                                <button 
                                    onClick={() => {
                                        const tru = formData.loc_poleCode || "...";
                                        const sub = formData.loc_subCode ? "/" + formData.loc_subCode : ""; 
                                        const tuyen = formData.loc_lineName || "...";
                                        const xa = formData.loc_commune || "...";
                                        const textDiaDiem = `Tr·ª• ${tru}${sub} tuy·∫øn ${tuyen}, , x√£ ${xa}, t·ªânh An Giang`;
                                        setFormData({ ...formData, muc4_diaDiem: textDiaDiem });
                                    }}
                                    className="bg-blue-600 text-white px-2 py-0.5 rounded text-xs font-bold hover:bg-blue-700 active:scale-95 transition-all flex items-center gap-1 shadow-sm"
                                    title="T·ª± ƒë·ªông l·∫•y: Tr·ª•... tuy·∫øn... x√£..."
                                >
                                    <UI_Icons.Plus size={12}/> D√°n ƒê.ƒêi·ªÉm
                                </button>
                            </div>
                            <textarea 
                                className="input-line w-full resize-none font-medium text-blue-900" 
                                rows="2" 
                                value={formData.muc4_diaDiem} 
                                onChange={e => setFormData({...formData, muc4_diaDiem: e.target.value})}
                            ></textarea>
                        </div>

                    {/* --- M·ª§C 5: N·ªòI DUNG C√îNG VI·ªÜC (C√ì DANH S√ÅCH M·∫™U) --- */}
                    <div className="mb-4">
                        <div className="flex flex-wrap items-center gap-2 mb-1">
                            <span className="font-bold">5. N·ªôi dung c√¥ng vi·ªác:</span>
                            
                            {/* Danh s√°ch ch·ªçn m·∫´u */}
                            <select 
                                className="border rounded px-2 py-1 text-sm bg-gray-50 outline-none focus:border-blue-500"
                                value={selectedTaskTemplate}
                                onChange={(e) => setSelectedTaskTemplate(e.target.value)}
                            >
                                <option value="">-- Ch·ªçn m·∫´u --</option>
                                {taskTemplates.map((t, i) => <option key={i} value={t}>{t}</option>)}
                            </select>

                            {/* N√∫t D√°n (+) */}
                            <button 
                                onClick={() => {
                                    if(!selectedTaskTemplate) return;
                                    // D√°n n·ªôi dung m·∫´u v√†o √¥ nh·∫≠p ch√≠nh (c√≥ th·ªÉ c·ªông d·ªìn ho·∫∑c thay th·∫ø t√πy b·∫°n, ·ªü ƒë√¢y t√¥i d√πng c·ªông d·ªìn)
                                    const newValue = formData.muc5_noiDung ? formData.muc5_noiDung + ", " + selectedTaskTemplate : selectedTaskTemplate;
                                    setFormData({...formData, muc5_noiDung: newValue});
                                }}
                                className="bg-blue-600 text-white px-3 py-1 rounded text-sm font-bold hover:bg-blue-700 active:scale-95 transition-all flex items-center gap-1"
                            >
                                <UI_Icons.Plus size={14}/> D√°n
                            </button>
                        </div>
                        
                        {/* √î nh·∫≠p li·ªáu ch√≠nh */}
                        <input 
                            className="input-line w-full font-medium text-blue-800" 
                            value={formData.muc5_noiDung} 
                            onChange={e => setFormData({...formData, muc5_noiDung: e.target.value})} 
                            placeholder="N·ªôi dung c√¥ng vi·ªác c·ª• th·ªÉ..."
                        />
                    </div>      

                    {/* --- M·ª§C 6: PH·∫†M VI (C√ì LIST CH·ªåN + N√öT D√ÅN T·ª∞ ƒê·ªòNG) --- */}
                        <div>
                            <div className="flex flex-wrap items-center gap-2 mb-1">
                                <span className="font-bold">6. Ph·∫°m vi l√†m vi·ªác:</span>
                                
                                {/* 1. List ch·ªçn m·∫´u */}
                                <select 
                                    className="border rounded px-2 py-1 text-sm bg-gray-50 outline-none focus:border-blue-500 max-w-[120px]"
                                    value={selectedScopeTemplate}
                                    onChange={(e) => setSelectedScopeTemplate(e.target.value)}
                                >
                                    <option value="">-- M·∫´u --</option>
                                    {scopeTemplates.map((t, i) => <option key={i} value={t}>{t}</option>)}
                                </select>

                                {/* 2. N√∫t D√°n t·ª´ List (+ D√°n) */}
                                <button 
                                    onClick={() => {
                                        if(!selectedScopeTemplate) return;
                                        const cur = formData.muc6_phamVi;
                                        // C·ªông d·ªìn v√†o n·ªôi dung c≈©
                                        setFormData({...formData, muc6_phamVi: cur ? cur + ", " + selectedScopeTemplate : selectedScopeTemplate});
                                    }}
                                    className="bg-blue-600 text-white px-2 py-0.5 rounded text-xs font-bold hover:bg-blue-700 active:scale-95 transition-all flex items-center gap-1 shadow-sm"
                                    title="D√°n n·ªôi dung t·ª´ danh s√°ch ch·ªçn"
                                >
                                    <UI_Icons.Plus size={12}/> D√°n
                                </button>

                                {/* 3. N√∫t D√°n Tr·ª•/Tuy·∫øn t·ª± ƒë·ªông (+ Tr·ª•/Tuy·∫øn) */}
                                <button 
                                    onClick={() => {
                                        const tru = formData.loc_poleCode || "...";
                                        const sub = formData.loc_subCode ? "/" + formData.loc_subCode : ""; 
                                        const tuyen = formData.loc_lineName || "...";
                                        // T·∫°o chu·ªói: tr·ª• ... tuy·∫øn ...
                                        const textAuto = `tr·ª• ${tru}${sub} tuy·∫øn ${tuyen}`;
                                        
                                        const cur = formData.muc6_phamVi;
                                        // C·ªông d·ªìn v√†o n·ªôi dung c≈© (th√™m kho·∫£ng tr·∫Øng)
                                        setFormData({...formData, muc6_phamVi: cur ? cur + " " + textAuto : textAuto});
                                    }}
                                    className="bg-blue-600 text-white px-2 py-0.5 rounded text-xs font-bold hover:bg-blue-700 active:scale-95 transition-all flex items-center gap-1 shadow-sm"
                                    title="T·ª± ƒë·ªông l·∫•y: tr·ª•... tuy·∫øn..."
                                >
                                    <UI_Icons.Plus size={12}/> Tr·ª•/Tuy·∫øn
                                </button>
                            </div>
                            
                            {/* √î nh·∫≠p li·ªáu ch√≠nh */}
                            <input 
                                className="input-line w-full font-medium text-blue-800" 
                                value={formData.muc6_phamVi} 
                                onChange={e => setFormData({...formData, muc6_phamVi: e.target.value})} 
                            />
                        </div>
                    
                    {/* M·ª•c 7 v·ªõi Input Date */}
                    <div><span className="font-bold">7. Th·ªùi gian ti·∫øn h√†nh c√¥ng vi·ªác:</span><div className="flex flex-wrap items-center gap-2 mt-1">T·ª´ <div className="mx-1"><TimeSelect value={formData.muc7_thoiGianTu} onChange={(val) => setFormData({...formData, muc7_thoiGianTu: val})} /></div>ƒë·∫øn <div className="mx-1"><TimeSelect value={formData.muc7_thoiGianDen} onChange={(val) => setFormData({...formData, muc7_thoiGianDen: val})} /></div>, ng√†y <input type="date" className="border-b border-gray-300 font-bold bg-transparent outline-none px-1 text-blue-800" value={formData.muc7_ngay} onChange={e => setFormData({...formData, muc7_ngay: e.target.value})} /></div></div></div>

                    <div className="mb-6"><div className="font-bold mb-2">8. K·∫øt qu·∫£ ƒê√°nh gi√° r·ªßi ro c·ªßa ƒë∆°n v·ªã c√¥ng t√°c:</div><div className="pl-4">
                        
                        {/* M·ª•c 8a v·ªõi Input Date */}
                        <div className="font-semibold mb-2 flex flex-wrap items-center gap-1">a) K·∫øt qu·∫£ ƒêGRR t·∫°i hi·ªán tr∆∞·ªùng (Theo Phi·∫øu ƒêGRR ng√†y <input type="date" className="border-b border-gray-400 outline-none px-1 font-bold bg-transparent text-blue-800" value={formData.phieu_dgrr_ngay} onChange={e => setFormData({...formData, phieu_dgrr_ngay: e.target.value})} />)</div>
                        
                        <table className="w-full"><thead><tr><th className="w-10">Stt</th><th className="w-1/4">Nh·∫≠n di·ªán m·ªëi nguy</th><th className="w-1/4">M√¥ t·∫£ m·ªëi nguy</th><th className="w-16">B·∫≠c RR</th><th>Bi·ªán ph√°p ki·ªÉm so√°t</th><th className="w-8"></th></tr></thead><tbody><tr><td colSpan="6" className="bg-gray-100 font-bold text-center text-blue-700 uppercase tracking-wide">ATLƒê (An to√†n lao ƒë·ªông)</td></tr>{formData.ruiRo_ATLD.map((item, index) => (<tr key={`atld-${index}`}><td className="text-center">{index + 1}</td><td><select className="w-full border-none outline-none bg-transparent cursor-pointer font-medium text-blue-900" value={item.riskId || ""} onChange={(e) => handleRiskTypeChange('ruiRo_ATLD', index, e)}><option value="">-- Ch·ªçn M·ªëi nguy --</option>{riskLibrary.risks.filter(r => r.loai !== 'VSLD').map(r => <option key={r.id} value={r.id}>{r.ten_moi_nguy}</option>)}</select>{!item.riskId && <input className="w-full text-xs border-t mt-1 placeholder-gray-400" placeholder="Ho·∫∑c nh·∫≠p tay..." value={item.moiNguy} onChange={(e) => updateRiskRowManual('ruiRo_ATLD', index, 'moiNguy', e.target.value)} />}</td><td className="cursor-pointer hover:bg-blue-50 relative group" onClick={() => openRiskModal('ruiRo_ATLD', index, 'moTa')}><div className="min-h-[3rem] whitespace-pre-wrap">{item.moTa || <span className="text-gray-400 italic text-xs">Ch·∫°m ƒë·ªÉ ch·ªçn...</span>}</div><div className="absolute top-1 right-1 opacity-0 group-hover:opacity-100"><UI_Icons.CheckSquare size={14} className="text-blue-500"/></div></td><td><select className="w-full text-center border-none outline-none bg-transparent cursor-pointer font-bold" value={item.bac} onChange={(e) => updateRiskRowManual('ruiRo_ATLD', index, 'bac', e.target.value)}><option value="I">I</option><option value="II">II</option><option value="III">III</option><option value="IV">IV</option><option value="V">V</option></select></td><td className="cursor-pointer hover:bg-blue-50 relative group" onClick={() => openRiskModal('ruiRo_ATLD', index, 'bienPhap')}><div className="min-h-[3rem] whitespace-pre-wrap">{item.bienPhap || <span className="text-gray-400 italic text-xs">Ch·∫°m ƒë·ªÉ ch·ªçn...</span>}</div><div className="absolute top-1 right-1 opacity-0 group-hover:opacity-100"><UI_Icons.CheckSquare size={14} className="text-blue-500"/></div></td><td className="text-center align-middle"><button onClick={() => removeRiskRow('ATLD', index)} className="text-red-500"><UI_Icons.Trash2 width="16"/></button></td></tr>))}<tr><td colSpan="6" className="text-center p-1"><button onClick={() => addRiskRow('ATLD')} className="text-sm text-blue-600 font-semibold flex items-center justify-center gap-1 w-full"><UI_Icons.Plus width="14"/> Th√™m d√≤ng ATLƒê</button></td></tr><tr><td colSpan="6" className="bg-gray-100 font-bold text-center text-green-700 uppercase tracking-wide">VSLƒê (V·ªá sinh lao ƒë·ªông)</td></tr>{formData.ruiRo_VSLD.map((item, index) => (<tr key={`vsld-${index}`}><td className="text-center">{index + 1}</td><td><select className="w-full border-none outline-none bg-transparent cursor-pointer font-medium text-green-900" value={item.riskId || ""} onChange={(e) => handleRiskTypeChange('ruiRo_VSLD', index, e)}><option value="">-- Ch·ªçn M·ªëi nguy --</option>{riskLibrary.risks.filter(r => r.loai === 'VSLD').map(r => <option key={r.id} value={r.id}>{r.ten_moi_nguy}</option>)}</select>{!item.riskId && <input className="w-full text-xs border-t mt-1 placeholder-gray-400" placeholder="Ho·∫∑c nh·∫≠p tay..." value={item.moiNguy} onChange={(e) => updateRiskRowManual('ruiRo_VSLD', index, 'moiNguy', e.target.value)} />}</td><td className="cursor-pointer hover:bg-green-50 relative group" onClick={() => openRiskModal('ruiRo_VSLD', index, 'moTa')}><div className="min-h-[3rem] whitespace-pre-wrap">{item.moTa || <span className="text-gray-400 italic text-xs">Ch·∫°m ƒë·ªÉ ch·ªçn...</span>}</div><div className="absolute top-1 right-1 opacity-0 group-hover:opacity-100"><UI_Icons.CheckSquare size={14} className="text-green-500"/></div></td><td><select className="w-full text-center border-none outline-none bg-transparent cursor-pointer font-bold" value={item.bac} onChange={(e) => updateRiskRowManual('ruiRo_VSLD', index, 'bac', e.target.value)}><option value="I">I</option><option value="II">II</option><option value="III">III</option><option value="IV">IV</option><option value="V">V</option></select></td><td className="cursor-pointer hover:bg-green-50 relative group" onClick={() => openRiskModal('ruiRo_VSLD', index, 'bienPhap')}><div className="min-h-[3rem] whitespace-pre-wrap">{item.bienPhap || <span className="text-gray-400 italic text-xs">Ch·∫°m ƒë·ªÉ ch·ªçn...</span>}</div><div className="absolute top-1 right-1 opacity-0 group-hover:opacity-100"><UI_Icons.CheckSquare size={14} className="text-green-500"/></div></td><td className="text-center align-middle"><button onClick={() => removeRiskRow('VSLD', index)} className="text-red-500"><UI_Icons.Trash2 width="16"/></button></td></tr>))}<tr><td colSpan="6" className="text-center p-1"><button onClick={() => addRiskRow('VSLD')} className="text-sm text-green-600 font-semibold flex items-center justify-center gap-1 w-full"><UI_Icons.Plus width="14"/> Th√™m d√≤ng VSLƒê</button></td></tr></tbody></table><div className="font-semibold">b) Ghi ch√∫:</div><textarea className="input-line" rows="4" value={formData.ruiRo_ghiChu} onChange={e => setFormData({...formData, ruiRo_ghiChu: e.target.value})} placeholder="C√°c bi·ªán ph√°p b·ªï sung..."></textarea></div></div>

                    <div className="mb-6"><div className="font-bold mb-2">9. Tr√°ch nhi·ªám c·ªßa c√°c ƒë∆°n v·ªã li√™n quan:</div><div className="pl-4 space-y-4"><QuickInputSection title="a/ ƒê·ªëi v·ªõi (c√°c) ƒë∆°n v·ªã qu·∫£n l√Ω v·∫≠n h√†nh (Th·ª±c hi·ªán c·∫Øt ƒëi·ªán):" value={formData.muc9a_catDien} onChange={(val) => setFormData({...formData, muc9a_catDien: val})} templates={tags9a} contextData={getContextData()} placeholder="- C·∫Øt CB..." /><QuickInputSection title="b/ ƒê·ªëi v·ªõi ƒë∆°n v·ªã c√¥ng t√°c (Bi·ªán ph√°p an to√†n):" value={formData.muc9b_anToan} onChange={(val) => setFormData({...formData, muc9b_anToan: val})} templates={tags9b} placeholder="- Chu·∫©n b·ªã..." /><div><label className="section-title block text-gray-800">c/ ƒê·ªëi v·ªõi (c√°c) ƒë∆°n v·ªã ƒëi·ªÅu ƒë·ªô (n·∫øu c√≥):</label><textarea className="input-line" rows="2" value={formData.muc9c_dieuDo} onChange={e => setFormData({...formData, muc9c_dieuDo: e.target.value})}></textarea></div><div><label className="section-title block text-gray-800">d/ Nh·ªØng n·ªôi dung kh√°c c√≥ li√™n quan ƒë·∫øn c√¥ng vi·ªác:</label><textarea className="input-line" rows="2" value={formData.muc9d_khac} onChange={e => setFormData({...formData, muc9d_khac: e.target.value})}></textarea></div></div></div>
                    <div className="mt-8 text-justify mb-8">Bi√™n b·∫£n n√†y ƒë∆∞·ª£c l·∫≠p th√†nh <input className="w-10 text-center border-b border-gray-300 font-bold" value={formData.soBan} onChange={e => setFormData({...formData, soBan: e.target.value})} /> b·∫£n v√† ƒë∆∞·ª£c t·∫•t c·∫£ m·ªçi ng∆∞·ªùi d·ª± h·ªçp l√† ƒë·∫°i di·ªán c·ªßa c√°c ƒë∆°n v·ªã c√≥ li√™n quan ƒë·∫øn c√¥ng vi·ªác ƒë·ªìng √Ω, th√¥ng qua ƒë·ªÉ l√†m c∆° s·ªü ti·∫øn h√†nh c√¥ng vi·ªác sau n√†y (n·∫øu kh√¥ng thay ƒë·ªïi v·ªÅ nh·ªØng n·ªôi dung ch√≠nh) v√† k√Ω t√™n d∆∞·ªõi ƒë√¢y.</div>
                    <div className="grid grid-cols-2 gap-8 text-center font-bold text-xs md:text-sm uppercase mb-20"><div>ƒê·∫†I DI·ªÜN ƒê∆†N V·ªä<br/>L√ÄM C√îNG VI·ªÜC<br/><div className="h-20"></div>{formData.dvct_daiDien1}</div><div>ƒê·∫†I DI·ªÜN (C√ÅC) ƒê∆†N V·ªä<br/>QU·∫¢N L√ù VH<br/><div className="h-20"></div>{formData.qlvh_daiDien1}</div><div>ƒê·∫†I DI·ªÜN (C√ÅC)<br/>ƒê∆†N V·ªä ƒêI·ªÄU ƒê·ªò<br/><div className="h-20"></div></div><div>ƒê·∫†I DI·ªÜN C√ÅC<br/>ƒê∆†N V·ªä LI√äN QUAN<br/><div className="h-20"></div></div></div>
                    
                    {/* Ph·∫ßn Ch·ª•p ·∫¢nh M·ªõi */}
                    <div className="mb-8 border-t-2 border-dashed pt-4 break-inside-avoid">
                        <div className="font-bold text-center mb-4 flex justify-between items-center px-4">
                            <span>H√åNH ·∫¢NH KH·∫¢O S√ÅT (L∆∞u n·ªôi b·ªô)</span>
                            <label className="camera-btn px-4 py-2 rounded-full cursor-pointer flex items-center gap-2 font-bold text-sm shadow-sm">
                                <UI_Icons.Plus size={18}/> Ch·ª•p/T·∫£i ·∫¢nh
                                <input type="file" accept="image/*" multiple capture="environment" className="hidden" onChange={handleImageUpload} />
                            </label>
                        </div>
                        {(!formData.hinh_anh || formData.hinh_anh.length === 0) ? (
                            <div className="text-center text-gray-400 italic py-4 bg-gray-50 rounded border border-gray-200">Ch∆∞a c√≥ h√¨nh ·∫£nh n√†o.</div>
                        ) : (
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                {formData.hinh_anh.map((url, index) => (
                                    <div key={index} className="relative group aspect-square bg-gray-100 rounded-lg overflow-hidden border border-gray-300 shadow-sm cursor-zoom-in" onClick={() => setZoomImage(url)}>
                                        <img src={url} alt={`·∫¢nh ${index+1}`} className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" />
                                        {/* N√∫t x√≥a (c·∫ßn stopPropagation ƒë·ªÉ kh√¥ng b·ªã k√≠ch ho·∫°t zoom khi b·∫•m x√≥a) */}
                                        <button onClick={(e) => { e.stopPropagation(); removeImage(index); }} className="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-80 hover:opacity-100 shadow-md transition-opacity"><UI_Icons.X size={14}/></button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    <div className="border-t-2 border-dashed pt-4 mt-8 break-inside-avoid"><div className="font-bold text-center mb-4">S∆† ƒê·ªí M·ªòT S·ª¢I K·∫æT N·ªêI THI·∫æT B·ªä, L∆Ø·ªöI ƒêI·ªÜN N∆†I L√ÄM VI·ªÜC</div><div className="relative w-full h-80 bg-gray-50 border border-gray-300 rounded-lg overflow-hidden group">{diagramData.length > 0 ?
(<DiagramPreview objects={diagramData} />) : (<div className="absolute inset-0 flex flex-col items-center justify-center text-gray-400"><UI_Icons.Share2 size={48} className="mb-2"/><span>(Ch∆∞a c√≥ s∆° ƒë·ªì)</span></div>)}<div className="absolute inset-0 bg-black/5 group-hover:bg-black/10 transition-colors flex items-center justify-center opacity-0 group-hover:opacity-100"><button onClick={() => setShowDiagram(true)} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg font-bold hover:bg-blue-700 transform hover:scale-105 transition-all flex items-center gap-2"><UI_Icons.FileText size={18}/> {diagramData.length > 0 ? "Ch·ªânh S·ª≠a S∆° ƒê·ªì" : "M·ªü Tr√¨nh V·∫Ω S∆° ƒê·ªì"}</button></div>{diagramData.length === 0 && (<div className="absolute inset-0 flex items-center justify-center md:hidden pointer-events-none"><div className="mt-16 pointer-events-auto"><button onClick={() => setShowDiagram(true)} className="bg-blue-100 text-blue-600 px-4 py-2 rounded text-sm font-semibold hover:bg-blue-200">M·ªü Tr√¨nh V·∫Ω S∆° ƒê·ªì</button></div></div>)}</div></div>
                </div>
                <div className="h-20"></div>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>

</body>
</html>
